<!DOCTYPE html>
<html
  lang="en-us"
  dir="ltr"
>
  <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='以现有 Pleroma 数据库为基础学习 postgreSQL 本地安装 PG 用 Homebrew 安装 brew install postgresql@13 添加环境变量 # ~/.zshrc &#43; # PostgreSQL &#43; export PATH=&amp;#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&amp;#34; &#43; export PGDATA=&amp;#34;/opt/homebrew/var/postgresql@13&amp;#34; 让修改生效 &amp;amp; 测试 source ~/.zshrc # 对配置文件的修改生效 pg_ctl -V # 查看版本'><title>初遇 PostgreSQL</title>

<link rel='canonical' href='https://falasool.github.io/post/postgresql/'>

<link rel="stylesheet" href="/scss/style.min.0147dab71443626c251957a4d123df288cfea1f5d5abc428ef3cc283bdafb846.css"><meta property='og:title' content='初遇 PostgreSQL'>
<meta property='og:description' content='以现有 Pleroma 数据库为基础学习 postgreSQL 本地安装 PG 用 Homebrew 安装 brew install postgresql@13 添加环境变量 # ~/.zshrc &#43; # PostgreSQL &#43; export PATH=&amp;#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&amp;#34; &#43; export PGDATA=&amp;#34;/opt/homebrew/var/postgresql@13&amp;#34; 让修改生效 &amp;amp; 测试 source ~/.zshrc # 对配置文件的修改生效 pg_ctl -V # 查看版本'>
<meta property='og:url' content='https://falasool.github.io/post/postgresql/'>
<meta property='og:site_name' content='Falasool'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='postgresql' /><meta property='article:tag' content='tech' /><meta property='article:tag' content='database' /><meta property='article:published_time' content='2023-06-26T11:21:32&#43;08:00'/><meta property='article:modified_time' content='2023-06-26T11:21:32&#43;08:00'/>
<meta name="twitter:title" content="初遇 PostgreSQL">
<meta name="twitter:description" content="以现有 Pleroma 数据库为基础学习 postgreSQL 本地安装 PG 用 Homebrew 安装 brew install postgresql@13 添加环境变量 # ~/.zshrc &#43; # PostgreSQL &#43; export PATH=&amp;#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&amp;#34; &#43; export PGDATA=&amp;#34;/opt/homebrew/var/postgresql@13&amp;#34; 让修改生效 &amp;amp; 测试 source ~/.zshrc # 对配置文件的修改生效 pg_ctl -V # 查看版本"><style>
   
  :root {
    --article-font-family: 'Noto Serif HK', var(--base-font-family);
  }
</style>

<script>
  ;(function () {
    const customFont = document.createElement('link')
    customFont.href =
      'https://fonts.googleapis.com/css2?family=Noto+Serif+HK:wght@300;400;500;600;700&display=swap'
    customFont.type = 'text/css'
    customFont.rel = 'stylesheet'

    document.head.appendChild(customFont)
  })()
</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://cdn.jsdelivr.net/gh/Falasool/blog-pic-bed@main//blogponder-favicon.png"
    />
  </head>
  <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "auto");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div
      class="container main-container flex on-phone--column compact"
    ><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Falasool</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        

        <li >
            <a href='/page/friends/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        

        <li >
            <a href='/page/badges/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-app-window" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M3 5m0 2a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2z" />
  <path d="M6 8h.01" />
  <path d="M9 8h.01" />
</svg>



                
                <span>Projects</span>
            </a>
        </li>
        
        

        <li >
            <a href='/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/posts' >
                
                
                
                <span>All posts</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/tags' >
                
                
                
                <span>Tags</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
  
  <header class="article-category">
    
    <a
      href="/categories/database/"
      
    >
      DataBase
    </a>
    
    <a
      href="/categories/fediverse/"
      style="background-color: #2a9d8f; color: #fff;"
      
    >
      Fediverse
    </a>
    
    <a
      href="/categories/todolist/"
      
    >
      ToDoList
    </a>
    
  </header>
  

  <div class="article-title-wrapper">
    <h2 class="article-title">
      <a href="/post/postgresql/">初遇 PostgreSQL</a>
    </h2>

    
  </div>

  
  

  
  
</div>

</header>

    <section class="article-content">
    
    
    
    <p>以现有 Pleroma 数据库为基础学习 postgreSQL</p>
<h2 id="本地安装-pg">本地安装 PG</h2>
<h3 id="用-homebrew-安装">用 Homebrew 安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>brew install postgresql@13
</span></span></code></pre></div><p>添加环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span># ~/.zshrc
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+ # PostgreSQL
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+ export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+ export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34;
</span></span></span></code></pre></div><p>让修改生效 &amp; 测试</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>source ~/.zshrc <span style="color:#75715e"># 对配置文件的修改生效</span>
</span></span><span style="display:flex;"><span>pg_ctl -V <span style="color:#75715e"># 查看版本，return `pg_ctl (PostgreSQL) 13.1` </span>
</span></span></code></pre></div><h3 id="dmg-安装">dmg 安装</h3>
<p><a class="link" href="https://www.enterprisedb.com/downloads/postgres-postgresql-downloads"  target="_blank" rel="noopener"
	>下载</a>


<span style="white-space: nowrap;"><svg width=".7em" height=".7em" viewBox="0 0 21 21"
		xmlns="http://www.w3.org/2000/svg">
		<path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
		<path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
			fill="currentColor">
	</svg></span>

</p>
<p>修改环境变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># PostgreSQL</span>
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Library/PostgreSQL/13/bin:</span>$PATH<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>source ~/.zshrc
</span></span></code></pre></div><h2 id="远程操作-pg">远程操作 PG</h2>
<h3 id="登录">登录</h3>
<p>允许远程登录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>locate postgresql.conf <span style="color:#75715e"># 定位文件位置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/postgresql/13/main/postgresql.conf </span>
</span></span><span style="display:flex;"><span>listen_addresses <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#75715e"># 修改内容</span>
</span></span></code></pre></div><p>添加客户端鉴定条目</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># /etc/postgresql/13/main/pg_hba.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 允许用户在提供有效口令（md5）后从某个 IP 地址登录</span>
</span></span><span style="display:flex;"><span>host all all 0.0.0.0/0 md5
</span></span><span style="display:flex;"><span>host all all ::0/0 md5
</span></span></code></pre></div><p>[可选]修改密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>postgres<span style="color:#f92672">=</span><span style="color:#75715e"># alter user postgres with password &#39;xxxxxxxx&#39;;</span>
</span></span><span style="display:flex;"><span>ALTER ROLE
</span></span></code></pre></div><p>最后重启 pg</p>
<p>但是不知道为啥（也许以后就知道了）我开启 5432 端口无效：ufw 命令返回结果显示已开启，防火墙规则添加了，ip 检查工具还是显示端口未开放。然后黛黛教了我端口转发</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ssh -L 127.0.0.1:5432:127.0.0.1:5432 username@hostname
</span></span></code></pre></div><p>连上之后保持打开这个窗口，我用 Navicat 连上了数据库，第一次见到了数据库到底是啥结构……（Navicat 是什么请看 <a class="link" href="https://www.navicat.com.cn/manual/online_manual/cn/navicat_16/win_manual/#/main_window"  target="_blank" rel="noopener"
	>用户手册</a>


<span style="white-space: nowrap;"><svg width=".7em" height=".7em" viewBox="0 0 21 21"
		xmlns="http://www.w3.org/2000/svg">
		<path d="m13 3l3.293 3.293l-7 7l1.414 1.414l7-7L21 11V3z" fill="currentColor" />
		<path d="M19 19H5V5h7l-2-2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2v-5l-2-2v7z"
			fill="currentColor">
	</svg></span>

）</p>
<p><img src="https://cdn.jsdelivr.net/gh/Falasool/blog-pic-bed@main//blog202307032252841.webp"
	
	
	
	loading="lazy"
	
		alt="image"
	
	
></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>└── public <span style="color:#75715e"># public 是默认的数据库模式（schema）。一个数据库可以包含多个模式，而每个模式又可以包含多个表、视图、函数等对象.schema 是一种逻辑容器，用于组织和管理数据库对象。它可以帮助在一个数据库中对不同的对象进行分类和分组</span>
</span></span><span style="display:flex;"><span>    ├── Tables <span style="color:#75715e"># 表是存储数据的基本对象，类似于电子表格或数据库中的表格。它们由行和列组成，用于存储和组织数据</span>
</span></span><span style="display:flex;"><span>    ├── Views <span style="color:#75715e"># 视图是虚拟表，是根据存储在其他表中的数据定义的查询结果。视图可以简化复杂查询，并提供一种方式来访问和使用数据</span>
</span></span><span style="display:flex;"><span>    ├── Materialized Views <span style="color:#75715e"># 材料化视图是一种特殊类型的视图，它在创建时将查询结果缓存为实际的表。与普通视图不同，材料化视图的内容在查询时不会再次计算，而是使用预先计算的结果</span>
</span></span><span style="display:flex;"><span>    ├── Functions <span style="color:#75715e"># 函数是一段封装了特定功能的可重用代码块。在数据库中，函数用于执行特定的计算、处理数据或返回结果</span>
</span></span><span style="display:flex;"><span>    ├── Queries
</span></span><span style="display:flex;"><span>    └── Backups
</span></span></code></pre></div><h3 id="解决数据库增长过快的问题到底解决了没有呢">解决数据库增长过快的问题（到底解决了没有呢？）</h3>
<p>前提：备份数据库</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 备份</span>
</span></span><span style="display:flex;"><span>mkdir -p /pleromabackup
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">777</span> /pleromabackup
</span></span><span style="display:flex;"><span>su - postgres
</span></span><span style="display:flex;"><span>psql -U postgres
</span></span><span style="display:flex;"><span>postgres<span style="color:#f92672">=</span><span style="color:#75715e"># \! pg_dump pleroma -f /pleromabackup/pleroma.pgdump</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查备份目录大小</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>xxx@xxx pleromabackup<span style="color:#f92672">]</span><span style="color:#75715e"># du -hs</span>
</span></span><span style="display:flex;"><span>341M    .
</span></span></code></pre></div><p>🌟 **查询所有表的行数：**创建一个 <code>count_em_all</code> 函数，然后调用它获得准确的统计信息</p>
<ol>
<li>创建：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TYPE</span> table_count <span style="color:#66d9ef">AS</span> (table_name TEXT, num_rows INTEGER); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">REPLACE</span> <span style="color:#66d9ef">FUNCTION</span> count_em_all () <span style="color:#66d9ef">RETURNS</span> <span style="color:#66d9ef">SETOF</span> table_count  <span style="color:#66d9ef">AS</span> <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DECLARE 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    the_count RECORD; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    t_name RECORD; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    r table_count%ROWTYPE; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">BEGIN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    FOR t_name IN 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        SELECT 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            c.relname
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        FROM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            pg_catalog.pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        WHERE 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            c.relkind = &#39;&#39;r&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            AND n.nspname = &#39;&#39;public&#39;&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        ORDER BY 1 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        LOOP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            FOR the_count IN EXECUTE &#39;&#39;SELECT COUNT(*) AS &#34;count&#34; FROM &#39;&#39; || t_name.relname 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            LOOP 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            END LOOP; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            r.table_name := t_name.relname; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            r.num_rows := the_count.count; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            RETURN NEXT r; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        END LOOP; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        RETURN; 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">END;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;</span> <span style="color:#66d9ef">LANGUAGE</span> plpgsql; 
</span></span></code></pre></div><ol start="2">
<li>调用</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span>
</span></span><span style="display:flex;"><span>	count_em_all ( ) <span style="color:#66d9ef">AS</span> r 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span>
</span></span><span style="display:flex;"><span>	r<span style="color:#ae81ff">.</span>num_rows <span style="color:#66d9ef">DESC</span>;
</span></span></code></pre></div><p>结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span>                 table_name                 <span style="color:#f92672">|</span> num_rows
</span></span><span style="display:flex;"><span><span style="color:#75715e">--------------------------------------------+----------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> activities                                 <span style="color:#f92672">|</span>   <span style="color:#ae81ff">171772</span>
</span></span><span style="display:flex;"><span> objects                                    <span style="color:#f92672">|</span>   <span style="color:#ae81ff">120664</span>
</span></span><span style="display:flex;"><span> hashtags_objects                           <span style="color:#f92672">|</span>    <span style="color:#ae81ff">38433</span>
</span></span><span style="display:flex;"><span> users                                      <span style="color:#f92672">|</span>    <span style="color:#ae81ff">22054</span>
</span></span><span style="display:flex;"><span> hashtags                                   <span style="color:#f92672">|</span>     <span style="color:#ae81ff">7719</span>
</span></span><span style="display:flex;"><span> deliveries                                 <span style="color:#f92672">|</span>     <span style="color:#ae81ff">5420</span>
</span></span><span style="display:flex;"><span> counter_cache                              <span style="color:#f92672">|</span>      <span style="color:#ae81ff">876</span>
</span></span><span style="display:flex;"><span> notifications                              <span style="color:#f92672">|</span>      <span style="color:#ae81ff">570</span>
</span></span><span style="display:flex;"><span> oauth_authorizations                       <span style="color:#f92672">|</span>      <span style="color:#ae81ff">479</span>
</span></span><span style="display:flex;"><span> oauth_tokens                               <span style="color:#f92672">|</span>      <span style="color:#ae81ff">474</span>
</span></span><span style="display:flex;"><span> following_relationships                    <span style="color:#f92672">|</span>      <span style="color:#ae81ff">472</span>
</span></span><span style="display:flex;"><span> schema_migrations                          <span style="color:#f92672">|</span>      <span style="color:#ae81ff">302</span>
</span></span><span style="display:flex;"><span> apps                                       <span style="color:#f92672">|</span>       <span style="color:#ae81ff">83</span>
</span></span><span style="display:flex;"><span> user_relationships                         <span style="color:#f92672">|</span>       <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span> conversation_participation_recipient_ships <span style="color:#f92672">|</span>       <span style="color:#ae81ff">36</span>
</span></span><span style="display:flex;"><span> instances                                  <span style="color:#f92672">|</span>       <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span> oban_jobs                                  <span style="color:#f92672">|</span>       <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span> conversation_participations                <span style="color:#f92672">|</span>       <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span> conversations                              <span style="color:#f92672">|</span>       <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span> config                                     <span style="color:#f92672">|</span>       <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span> bookmarks                                  <span style="color:#f92672">|</span>        <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span> markers                                    <span style="color:#f92672">|</span>        <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span> user_notes                                 <span style="color:#f92672">|</span>        <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> data_migrations                            <span style="color:#f92672">|</span>        <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> backups                                    <span style="color:#f92672">|</span>        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> moderation_log                             <span style="color:#f92672">|</span>        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> password_reset_tokens                      <span style="color:#f92672">|</span>        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> lists                                      <span style="color:#f92672">|</span>        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> oban_peers                                 <span style="color:#f92672">|</span>        <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span> announcements                              <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> filters                                    <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> announcement_read_relationships            <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> data_migration_failed_ids                  <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> mfa_tokens                                 <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> chats                                      <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> chat_message_references                    <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> push_subscriptions                         <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> registrations                              <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> report_notes                               <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> scheduled_activities                       <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> thread_mutes                               <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> user_invite_tokens                         <span style="color:#f92672">|</span>        <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">42</span> <span style="color:#66d9ef">rows</span>)
</span></span></code></pre></div><p>🌟 <strong>查询所有表的总大小</strong>（括表数据文件、索引文件、TOAST表、Free Space Map等对象的大小）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">SELECT</span> relname, pg_size_pretty(pg_total_relation_size(relid)) <span style="color:#66d9ef">AS</span> size_mb
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> pg_stat_user_tables
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> pg_total_relation_size(relid) <span style="color:#66d9ef">DESC</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                  relname                   <span style="color:#f92672">|</span> size_mb 
</span></span><span style="display:flex;"><span><span style="color:#75715e">--------------------------------------------+---------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> objects                                    <span style="color:#f92672">|</span> <span style="color:#ae81ff">266</span> MB
</span></span><span style="display:flex;"><span> activities                                 <span style="color:#f92672">|</span> <span style="color:#ae81ff">258</span> MB
</span></span><span style="display:flex;"><span> oban_jobs                                  <span style="color:#f92672">|</span> <span style="color:#ae81ff">100</span> MB
</span></span><span style="display:flex;"><span> users                                      <span style="color:#f92672">|</span> <span style="color:#ae81ff">64</span> MB
</span></span><span style="display:flex;"><span> hashtags_objects                           <span style="color:#f92672">|</span> <span style="color:#ae81ff">4096</span> kB
</span></span><span style="display:flex;"><span> hashtags                                   <span style="color:#f92672">|</span> <span style="color:#ae81ff">1288</span> kB
</span></span><span style="display:flex;"><span> deliveries                                 <span style="color:#f92672">|</span> <span style="color:#ae81ff">960</span> kB
</span></span><span style="display:flex;"><span> oauth_tokens                               <span style="color:#f92672">|</span> <span style="color:#ae81ff">592</span> kB
</span></span><span style="display:flex;"><span> oauth_authorizations                       <span style="color:#f92672">|</span> <span style="color:#ae81ff">344</span> kB
</span></span><span style="display:flex;"><span> notifications                              <span style="color:#f92672">|</span> <span style="color:#ae81ff">240</span> kB
</span></span><span style="display:flex;"><span> following_relationships                    <span style="color:#f92672">|</span> <span style="color:#ae81ff">232</span> kB
</span></span><span style="display:flex;"><span> counter_cache                              <span style="color:#f92672">|</span> <span style="color:#ae81ff">208</span> kB
</span></span><span style="display:flex;"><span> apps                                       <span style="color:#f92672">|</span> <span style="color:#ae81ff">176</span> kB
</span></span><span style="display:flex;"><span> instances                                  <span style="color:#f92672">|</span> <span style="color:#ae81ff">96</span> kB
</span></span><span style="display:flex;"><span> conversation_participations                <span style="color:#f92672">|</span> <span style="color:#ae81ff">88</span> kB
</span></span><span style="display:flex;"><span> lists                                      <span style="color:#f92672">|</span> <span style="color:#ae81ff">80</span> kB
</span></span><span style="display:flex;"><span> markers                                    <span style="color:#f92672">|</span> <span style="color:#ae81ff">80</span> kB
</span></span><span style="display:flex;"><span> oban_peers                                 <span style="color:#f92672">|</span> <span style="color:#ae81ff">80</span> kB
</span></span><span style="display:flex;"><span> schema_migrations                          <span style="color:#f92672">|</span> <span style="color:#ae81ff">64</span> kB
</span></span><span style="display:flex;"><span> conversation_participation_recipient_ships <span style="color:#f92672">|</span> <span style="color:#ae81ff">56</span> kB
</span></span><span style="display:flex;"><span> user_relationships                         <span style="color:#f92672">|</span> <span style="color:#ae81ff">56</span> kB
</span></span><span style="display:flex;"><span> data_migrations                            <span style="color:#f92672">|</span> <span style="color:#ae81ff">48</span> kB
</span></span><span style="display:flex;"><span> config                                     <span style="color:#f92672">|</span> <span style="color:#ae81ff">48</span> kB
</span></span><span style="display:flex;"><span> backups                                    <span style="color:#f92672">|</span> <span style="color:#ae81ff">48</span> kB
</span></span><span style="display:flex;"><span> conversations                              <span style="color:#f92672">|</span> <span style="color:#ae81ff">40</span> kB
</span></span><span style="display:flex;"><span> bookmarks                                  <span style="color:#f92672">|</span> <span style="color:#ae81ff">40</span> kB
</span></span><span style="display:flex;"><span> user_notes                                 <span style="color:#f92672">|</span> <span style="color:#ae81ff">40</span> kB
</span></span><span style="display:flex;"><span> filters                                    <span style="color:#f92672">|</span> <span style="color:#ae81ff">32</span> kB
</span></span><span style="display:flex;"><span> scheduled_activities                       <span style="color:#f92672">|</span> <span style="color:#ae81ff">32</span> kB
</span></span><span style="display:flex;"><span> registrations                              <span style="color:#f92672">|</span> <span style="color:#ae81ff">32</span> kB
</span></span><span style="display:flex;"><span> chat_message_references                    <span style="color:#f92672">|</span> <span style="color:#ae81ff">32</span> kB
</span></span><span style="display:flex;"><span> moderation_log                             <span style="color:#f92672">|</span> <span style="color:#ae81ff">32</span> kB
</span></span><span style="display:flex;"><span> password_reset_tokens                      <span style="color:#f92672">|</span> <span style="color:#ae81ff">24</span> kB
</span></span><span style="display:flex;"><span> push_subscriptions                         <span style="color:#f92672">|</span> <span style="color:#ae81ff">24</span> kB
</span></span><span style="display:flex;"><span> user_invite_tokens                         <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> mfa_tokens                                 <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> announcement_read_relationships            <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> thread_mutes                               <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> announcements                              <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> report_notes                               <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> chats                                      <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span> data_migration_failed_ids                  <span style="color:#f92672">|</span> <span style="color:#ae81ff">16</span> kB
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">42</span> <span style="color:#66d9ef">rows</span>)
</span></span></code></pre></div><p>列出行数和 size 排前五的表</p>
<p>🌟 <strong>activities 表</strong></p>
<p>type 字段的所有值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">DISTINCT</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;type&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> activities;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">?</span><span style="color:#66d9ef">column</span><span style="color:#f92672">?</span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> Follow
</span></span><span style="display:flex;"><span> Block
</span></span><span style="display:flex;"><span> Announce
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">Move</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">Delete</span>
</span></span><span style="display:flex;"><span> Undo
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">Create</span>
</span></span><span style="display:flex;"><span> EmojiReact
</span></span><span style="display:flex;"><span> Remove
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">Update</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">Like</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">Add</span>
</span></span><span style="display:flex;"><span> Reject
</span></span><span style="display:flex;"><span> Accept
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">14</span> <span style="color:#66d9ef">rows</span>)
</span></span></code></pre></div><p>列出值是 Announce 的所有行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> activities <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Announce&#39;</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span><span style="color:#ae81ff">.</span><span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>pleroma_ctl <span style="color:#66d9ef">database</span> <span style="color:#66d9ef">vacuum</span> <span style="color:#66d9ef">full</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;actor&#34;</span>, a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;type&#39;</span> <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">type</span>, a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;updated_at&#34;</span>, o<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#34;activities&#34;</span> <span style="color:#66d9ef">AS</span> a 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#e6db74">&#34;objects&#34;</span> <span style="color:#66d9ef">AS</span> o
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ON</span> (o<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span>) <span style="color:#f92672">=</span> <span style="color:#66d9ef">COALESCE</span>(a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;object&#39;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span>, a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;object&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;actor&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">OR</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;to&#39;</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">OR</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;cc&#39;</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;updated_at&#34;</span>;
</span></span></code></pre></div><p>🌟 users 表里有很多很多只有 nickname 的用户，它们所在实例是真实的，但是 ID 不是，我把这些行删了，暂时还没出问题</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">name</span> <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> users <span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">name</span> <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>;
</span></span></code></pre></div><p>🌟 删除了一个 bot 的记录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> objects
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;actor&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://xx.ca/users/xxxBot&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> objects
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> <span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;actor&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://xx.ca/users/xxxBot&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#ae81ff">485</span>
</span></span></code></pre></div><p>🌟 删除了 activities 表 2023-06-15 之前、与我无讨论关系、书签以外的内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> activities 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> id <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#66d9ef">SELECT</span> activity_id <span style="color:#66d9ef">FROM</span> bookmarks) 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> inserted_at <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;2023-06-15&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">AND</span> id <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SELECT</span> a<span style="color:#ae81ff">.</span>id
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FROM</span> activities <span style="color:#66d9ef">AS</span> a
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> objects <span style="color:#66d9ef">AS</span> o <span style="color:#66d9ef">ON</span> (o<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span>) <span style="color:#f92672">=</span> <span style="color:#66d9ef">COALESCE</span>(a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;object&#39;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span>, a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;object&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">WHERE</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;actor&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">OR</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;to&#39;</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">OR</span> a<span style="color:#ae81ff">.</span><span style="color:#e6db74">&#34;data&#34;</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;cc&#39;</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#ae81ff">89430</span>
</span></span></code></pre></div><p>🌟 删除了 objects 表与以上内容对应的行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">创建一个临时表 temp_objects 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">来存储那些在 activities 表中找不到对应行的 objects 表的行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TEMPORARY</span> <span style="color:#66d9ef">TABLE</span> temp_objects <span style="color:#66d9ef">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> o<span style="color:#ae81ff">.</span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> objects o
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> activities a <span style="color:#66d9ef">ON</span> o<span style="color:#ae81ff">.</span><span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span> <span style="color:#f92672">=</span> a<span style="color:#ae81ff">.</span><span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;object&#39;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> a<span style="color:#ae81ff">.</span><span style="color:#66d9ef">data</span><span style="color:#f92672">-&gt;</span><span style="color:#e6db74">&#39;object&#39;</span><span style="color:#f92672">-&gt;&gt;</span><span style="color:#e6db74">&#39;id&#39;</span> <span style="color:#66d9ef">IS</span> <span style="color:#66d9ef">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#ae81ff">128652</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">报错：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">执行删除操作时违反了外键约束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">objects 表中的某些行仍然被 deliveries 表引用，因此无法直接删除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">deliveries 表是用于跟踪消息传递的表，通常在 ActivityPub 协议的实现中使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">它记录了消息传递的相关信息，例如发送方、接收方、消息内容等
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">每条记录代表一次消息传递或交互。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">在 Pleroma 中，deliveries 表用于存储消息的传递状态和相关信息，以确保消息能够正确地传递给目标用户
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">它与 objects 表和 activities 表之间可能存在外键关系，用于保证数据的完整性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> objects
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> id <span style="color:#66d9ef">IN</span> (<span style="color:#66d9ef">SELECT</span> id <span style="color:#66d9ef">FROM</span> temp_objects);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ERROR:  <span style="color:#66d9ef">update</span> <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">delete</span> <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#34;objects&#34;</span> violates <span style="color:#66d9ef">foreign</span> <span style="color:#66d9ef">key</span> <span style="color:#66d9ef">constraint</span> <span style="color:#e6db74">&#34;deliveries_object_id_fkey&#34;</span> <span style="color:#66d9ef">on</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#34;deliveries&#34;</span>
</span></span><span style="display:flex;"><span>DETAIL:  <span style="color:#66d9ef">Key</span> (id)<span style="color:#f92672">=</span>(<span style="color:#ae81ff">75072</span>) <span style="color:#66d9ef">is</span> still referenced <span style="color:#66d9ef">from</span> <span style="color:#66d9ef">table</span> <span style="color:#e6db74">&#34;deliveries&#34;</span><span style="color:#ae81ff">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">所以先删除被 deliveries 表引用的行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> deliveries
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> user_id <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">IN</span> (<span style="color:#66d9ef">SELECT</span> id <span style="color:#66d9ef">FROM</span> activities);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#ae81ff">6372</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">继续执行删除操作并删除临时表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> objects
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> id <span style="color:#66d9ef">IN</span> (<span style="color:#66d9ef">SELECT</span> id <span style="color:#66d9ef">FROM</span> temp_objects);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#ae81ff">128652</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pleroma<span style="color:#f92672">=#</span> <span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> temp_objects;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span>
</span></span></code></pre></div><p>最后 <code>su pleroma -s $SHELL -lc &quot;./bin/pleroma_ctl database vacuum full &quot;</code>，但是！SQL 命令有问题，删了我好多嘟，呜呜呜哭着倒地。重新看了一下数据库大小，现在倒是变得迷你了，164 MB。但是这一切真的值得吗……完全在我计划外的……</p>
<h3 id="常用-psql-命令">常用 psql 命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-postgresql" data-lang="postgresql"><span style="display:flex;"><span>psql <span style="color:#f92672">-</span>U postgres <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">指定用户连接</span>PostgreSQL
</span></span><span style="display:flex;"><span>psql <span style="color:#f92672">-</span>d postgres <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">指定数据库连接</span>PostgreSQL
</span></span><span style="display:flex;"><span>psql <span style="color:#f92672">-</span>h <span style="color:#ae81ff">127.0.0.1</span> <span style="color:#f92672">-</span>p <span style="color:#ae81ff">5432</span> <span style="color:#f92672">-</span>U pg <span style="color:#f92672">-</span>d postgres <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">连接到本地主机（</span><span style="color:#ae81ff">127.0.0.1</span><span style="color:#960050;background-color:#1e0010">）的</span> PostgreSQL <span style="color:#960050;background-color:#1e0010">数据库服务器，使用用户名</span> pg <span style="color:#960050;background-color:#1e0010">连接到名为</span> postgres <span style="color:#960050;background-color:#1e0010">的数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>du <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">查看所有用户</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>l <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">查看所有数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>c{dbname} <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">切换到数据库</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>dt <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">查看当前数据库的所有表</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>d {tablename} <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">查看指定表</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SHOW</span> data_directory; <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">查看数据目录</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span>q <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">退出交互查询模式</span>
</span></span></code></pre></div>
    
</section>


    <footer class="article-footer">
  
    <section class="article-tags">
        
            <a href="/tags/postgresql/">postgresql</a>
        
            <a href="/tags/tech/">tech</a>
        
            <a href="/tags/database/">database</a>
        
    </section>


  </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title"></h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/post/nginx-memos/">
        
        

        <div class="article-details">
            <h2 class="article-title">Nginx</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/domain/">
        
        

        <div class="article-details">
            <h2 class="article-title">博客域名设置</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/picture-bed/">
        
        

        <div class="article-details">
            <h2 class="article-title">Hugo | 给博客配置图床</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/hugo-comment-system-disqusjs/">
        
        

        <div class="article-details">
            <h2 class="article-title">Hugo | 给博客添加评论系统</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/post/hugo-front-matter/">
        
        

        <div class="article-details">
            <h2 class="article-title">Hugo | Front Matter</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
  <section class="copyright">
    &copy;  2024 Falasool
  </section>

  <section class="powerby">
    
    <br />
    
  </section>

  <section class="busuanzi">
    <span id="busuanzi_container_site_uv" style='display:none'>
      <span id="busuanzi_value_site_uv"></span> Views
    </span>
  </section>
</footer>

<style>
  .busuanzi {
    color: var(--body-text-color);
    font-weight: 400;
    font-size: 1.2rem;
  }
</style>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
</main>
    

    </div>
    <script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<a href="#" id="back-to-top" title="返回顶部"></a>


<style>
  #back-to-top {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 55px;
    width: 55px;
    height: 55px;
    border-radius: 7px;
    background-color: rgba(210, 179, 75, 0.5);
    box-shadow: var(--shadow-l2);
    font-size: 30px;
    text-align: center;
    line-height: 50px;
    cursor: pointer;
  }

  #back-to-top:before {
    content: ' ';
    display: inline-block;
    position: relative;
    top: 0;
    transform: rotate(135deg);
    height: 10px;
    width: 10px;
    border-width: 0 0 2px 2px;
    border-color: var(--back-to-top-color);
    border-style: solid;
  }

  #back-to-top:hover:before {
    border-color: rgb(210, 179, 75);
  }

   
  @media screen and (max-width: 768px) {
    #back-to-top {
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      font-size: 10px;
    }
  }

   
  @media screen and (min-width: 1024px) {
    #back-to-top {
      bottom: 20px;
      right: 40px;
    }
  }

   
  @media screen and (min-width: 1280px) {
    #back-to-top {
      bottom: 20px;
      right: 55px;
    }
  }

   
  @media screen and (min-width: 1536px) {
    #back-to-top {
      visibility: hidden;
    }
  }
</style>


<script>
  function backToTop() {
    document.documentElement.scrollIntoView({
      behavior: 'smooth',
    })
  }

  window.onload = function () {
    let scrollTop =
      this.document.documentElement.scrollTop || this.document.body.scrollTop
    let totopBtn = this.document.getElementById('back-to-top')
    if (scrollTop > 0) {
      totopBtn.style.display = 'inline'
    } else {
      totopBtn.style.display = 'none'
    }
  }

  window.onscroll = function () {
    let scrollTop =
      this.document.documentElement.scrollTop || this.document.body.scrollTop
    let totopBtn = this.document.getElementById('back-to-top')
    if (scrollTop < 200) {
      totopBtn.style.display = 'none'
    } else {
      totopBtn.style.display = 'inline'
      totopBtn.addEventListener('click', backToTop, false)
    }
  }
</script>

  </body>
</html>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js"></script>

<script
  type="text/javascript"
  src="https://demo.hellozwh.com/source/canvas-nest.min.js"
></script>

<script>
  pangu.spacingPage()
</script>

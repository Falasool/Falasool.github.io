<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Html5|新特性PushState - Falasool</title><link rel=icon type=image/png href=static/img/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="为一碟醋______，请食"><meta property="og:image" content><meta property="og:title" content="Html5|新特性PushState"><meta property="og:description" content="为一碟醋______，请食"><meta property="og:type" content="article"><meta property="og:url" content="https://falasool.github.io/posts/html5-pushstate/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-12T19:39:03+08:00"><meta property="article:modified_time" content="2024-03-12T19:39:03+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Html5|新特性PushState"><meta name=twitter:description content="为一碟醋______，请食"><script src=https://falasool.github.io/js/feather.min.js></script>
<link href=https://falasool.github.io/css/fonts.4bacf4386d3f58fdc378d205a903311c80158bf414d25698589b658e0273156d.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://falasool.github.io/css/main.a562939875f5647d4bcd33af2971cc96f9630e2452c4aa7c92f5f25e14077830.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://falasool.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://falasool.github.io/>Falasool</a></div><nav><a href=/friends/></a>
<a href=/about>About</a>
<a href=/friends>Friends</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Html5|新特性PushState</h1><div class=meta>Posted on Mar 12, 2024</div></div><section class=body><h2 id=history>History</h2><p><code>history.pushState()</code> 是什么？简单来说，是目前浏览器已经普遍支持的一种添加浏览历史记录的方法。</p><p>首先，让我们来看看 <code>history</code> 对象，它保存了当前窗口访问过的所有页面网址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// Console
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>history</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>History</span> {<span style=color:#a6e22e>length</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>scrollRestoration</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;auto&#39;</span>, <span style=color:#a6e22e>state</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>pushState</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ƒ</span>, <span style=color:#a6e22e>replaceState</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ƒ</span>}
</span></span></code></pre></div><p>length & go/forward/back</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>window.<span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>length</span> <span style=color:#75715e>// 3，当前窗口访问过三个地址（包括当前地址）
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 浏览器的前进/后退按钮的实际操作（从browser cache中加载），以下两者等同
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>back</span>() <span style=color:#75715e>// history.go(-1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>forward</span>() <span style=color:#75715e>// history.go(1)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>go</span>(<span style=color:#ae81ff>0</span>) <span style=color:#75715e>// default 为 0，刷新当前页面
</span></span></span></code></pre></div><p>scrollRestoration</p><p>滚动恢复行为：auto/manual 恢复到用户之前滚动到的地方/不管（</p><h3 id=pushstate>pushState</h3><p>向历史中添加一条记录（state对象，新页面标题，新的地址）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>window.<span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>pushState</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>title</span>, <span style=color:#a6e22e>url</span>)
</span></span></code></pre></div><p>参数：</p><ul><li>state：popstate 事件触发时（back、go、forward前进后退会触发），state对象会传入回调参数，那么 popstate 的属性 state 就会包含当前历史记录的 state 对象的一个 copy，储存在磁盘里，当浏览器重启时可以恢复（&lt; 16MiB），更多空间的话建议使用 sessionStorage / localStorage</li><li>title：新网址 title</li><li>url：新网址 url</li></ul><p>🙋 那我为什么用 pushState不用 <code>window.location = '#foo'</code>呢？</p><p>pushState的优点：</p><ul><li>跳转后页面不会发起新的文档请求</li><li>新 URL 可以是和当前URL同源（跨域报错）的任意URL，浏览器添加history记录但是并不真的加载，也就是说假的也没事</li><li>push 的历史记录可以关联任意数据，基于hash值的话，必须将相关数据编码到一个短字符串里</li></ul><p>等等，<code>popstate</code> 事件能讲讲吗？</p><h3 id=popstate-事件>popstate 事件</h3><p>处于激活状态的历史记录条目发生变化时（调用 go/forward/back），popstate 就会在对应的 window 对象上触发。popstate 的对调函数的参数 event.state 指向 pushState 的 state</p><p>if 这个历史记录是用 <code>pushState</code> 或<code>replaceState</code> 操作过的，不会触发 popstate 事件</p><p>⭐️ 应用：用户要离开当前页面时 popup 做二次确认（beforeunload）</p><p>监听 popstate 事件，一旦被触发，添加1条记录 <code>history.pushState(null, null, document.URL)</code> 留在当前页面</p><blockquote><p>当popstate 被触发时，记录已经回退了。在回退之前再添加一条当前 URL 的记录，以保证回退后 URL 不变</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>pushState</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, <span style=color:#e6db74>&#39;/a&#39;</span>)
</span></span><span style=display:flex><span>window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#39;popstate&#39;</span>, () =&gt; { <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#39;您确认要离开吗？&#39;</span>) })
</span></span><span style=display:flex><span><span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>pushState</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>null</span>, document.<span style=color:#a6e22e>URL</span>)
</span></span></code></pre></div><p>⭐️ 应用：用户想从 A 页面进入一个无权限查看的地址B，让用户跳转到error.html C，用户返回时直接从 C->A</p><p>在 B 向 C 跳转时，使用 <code>history.replace</code> 把 B 替换为 C，这样记录就从A-B-C 变成，A-C。在 C 页面 back 直接回到 A</p><h3 id=windowlocation>window.location</h3><p><a href=https://www.w3schools.com/js/js_window_location.asp>https://www.w3schools.com/js/js_window_location.asp</a></p><h3 id=replacestate>replaceState</h3><p>修改当前的历史记录项</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>window.<span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>replaceState</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>title</span>, <span style=color:#a6e22e>url</span>)
</span></span></code></pre></div><p>🎉 醋来了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>html</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>head</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>title</span><span style=color:#f92672>&gt;</span><span style=color:#a6e22e>wait</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>sec</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>BOOM</span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/title&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/head&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>body</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>h1</span><span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>🚀</span><span style=color:#a6e22e>抓紧</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>要上天了</span><span style=color:#960050;background-color:#1e0010>！🚀</span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/h1&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#a6e22e>script</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>total</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1000000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>total</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>total</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>i</span>.<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>history</span>.<span style=color:#a6e22e>pushState</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#a6e22e>total</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/script&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/body&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>/html&gt;</span>
</span></span></code></pre></div><p>向你的浏览器历史里塞进 1000000 条记录😂 （雾</p><p>这段代码来自 <a href=https://twitter.com/fatih_svml/status/689070600653041664>Fatih Sevimli</a></p><p>来都来了复习一下：</p><h2 id=sessionstorage-vs-localstorage>sessionStorage vs localStorage</h2><p>while data in localStorage doesn&rsquo;t expire, data in sessionStorage is cleared when the page session ends.</p><table><thead><tr><th>🍪cookie</th><th>session</th></tr></thead><tbody><tr><td>储存在客户端</td><td>服务器端</td></tr><tr><td>ASCII</td><td>任意</td></tr><tr><td>实效长</td><td>短</td></tr><tr><td>4k</td><td>高</td></tr></tbody></table><p><a href=https://www.cnblogs.com/ityouknow/p/10856177.html>你真的了解cookie和session吗</a></p><h2 id=参考--致谢>参考 & 致谢</h2><p><a href=https://javascript.ruanyifeng.com/bom/history.html>https://javascript.ruanyifeng.com/bom/history.html</a></p><p><a href=https://juejin.cn/post/6948746074504986655>[高级]深入浅出浏览器的history对象</a></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/html>HTML</a></li><li><a href=/tags/tech>tech</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/falasool/ rel=me title=GitHub><i data-feather=github></i></a></div><div class=footer-info>2024 © Falaool | Built with <a href=https://gohugo.io>Hugo</a> & Theme <a href=https://github.com/athul/archie>Archie</a> design by Athul</div></footer><script>feather.replace()</script></div></body></html>
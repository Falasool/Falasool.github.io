<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>初遇 PostgreSQL - Falasool</title><link rel=icon type=image/png href=static/img/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="以现有 Pleroma 数据库为基础学习 postgreSQL 本地安装 PG 用 Homebrew 安装 brew install postgresql@13 添加环境变量 # ~/.zshrc + # PostgreSQL + export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34; + export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34; 让修改生效 & 测试 source ~/.zshrc # 对配置文件的修改生效 pg_ctl -V # 查看版本"><meta property="og:image" content><meta property="og:title" content="初遇 PostgreSQL"><meta property="og:description" content="以现有 Pleroma 数据库为基础学习 postgreSQL 本地安装 PG 用 Homebrew 安装 brew install postgresql@13 添加环境变量 # ~/.zshrc + # PostgreSQL + export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34; + export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34; 让修改生效 & 测试 source ~/.zshrc # 对配置文件的修改生效 pg_ctl -V # 查看版本"><meta property="og:type" content="article"><meta property="og:url" content="https://falasool.github.io/posts/postgresql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-26T11:21:32+08:00"><meta property="article:modified_time" content="2023-06-26T11:21:32+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="初遇 PostgreSQL"><meta name=twitter:description content="以现有 Pleroma 数据库为基础学习 postgreSQL 本地安装 PG 用 Homebrew 安装 brew install postgresql@13 添加环境变量 # ~/.zshrc + # PostgreSQL + export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34; + export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34; 让修改生效 & 测试 source ~/.zshrc # 对配置文件的修改生效 pg_ctl -V # 查看版本"><script src=https://falasool.github.io/js/feather.min.js></script>
<link href=https://falasool.github.io/css/fonts.4bacf4386d3f58fdc378d205a903311c80158bf414d25698589b658e0273156d.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://falasool.github.io/css/main.a562939875f5647d4bcd33af2971cc96f9630e2452c4aa7c92f5f25e14077830.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://falasool.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://falasool.github.io/>Falasool</a></div><nav><a href=/friends/></a>
<a href=/about>About</a>
<a href=/friends>Friends</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>初遇 PostgreSQL</h1><div class=meta>Posted on Jun 26, 2023</div></div><section class=body><p>以现有 Pleroma 数据库为基础学习 postgreSQL</p><h2 id=本地安装-pg>本地安装 PG</h2><h3 id=用-homebrew-安装>用 Homebrew 安装</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install postgresql@13
</span></span></code></pre></div><p>添加环境变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># ~/.zshrc
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ # PostgreSQL
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34;
</span></span></span></code></pre></div><p>让修改生效 & 测试</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>source ~/.zshrc <span style=color:#75715e># 对配置文件的修改生效</span>
</span></span><span style=display:flex><span>pg_ctl -V <span style=color:#75715e># 查看版本，return `pg_ctl (PostgreSQL) 13.1` </span>
</span></span></code></pre></div><h3 id=dmg-安装>dmg 安装</h3><p><a href=https://www.enterprisedb.com/downloads/postgres-postgresql-downloads>下载</a></p><p>修改环境变量</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># PostgreSQL</span>
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/Library/PostgreSQL/13/bin:</span>$PATH<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>source ~/.zshrc
</span></span></code></pre></div><h2 id=远程操作-pg>远程操作 PG</h2><h3 id=登录>登录</h3><p>允许远程登录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>locate postgresql.conf <span style=color:#75715e># 定位文件位置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /etc/postgresql/13/main/postgresql.conf </span>
</span></span><span style=display:flex><span>listen_addresses <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;*&#39;</span> <span style=color:#75715e># 修改内容</span>
</span></span></code></pre></div><p>添加客户端鉴定条目</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># /etc/postgresql/13/main/pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 允许用户在提供有效口令（md5）后从某个 IP 地址登录</span>
</span></span><span style=display:flex><span>host all all 0.0.0.0/0 md5
</span></span><span style=display:flex><span>host all all ::0/0 md5
</span></span></code></pre></div><p>[可选]修改密码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># alter user postgres with password &#39;xxxxxxxx&#39;;</span>
</span></span><span style=display:flex><span>ALTER ROLE
</span></span></code></pre></div><p>最后重启 pg</p><p>但是不知道为啥（也许以后就知道了）我开启 5432 端口无效：ufw 命令返回结果显示已开启，防火墙规则添加了，ip 检查工具还是显示端口未开放。然后黛黛教了我端口转发</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh -L 127.0.0.1:5432:127.0.0.1:5432 username@hostname
</span></span></code></pre></div><p>连上之后保持打开这个窗口，我用 Navicat 连上了数据库，第一次见到了数据库到底是啥结构……（Navicat 是什么请看 <a href=https://www.navicat.com.cn/manual/online_manual/cn/navicat_16/win_manual/#/main_window>用户手册</a>）</p><p><img src=https://cdn.jsdelivr.net/gh/Falasool/blog-pic-bed@main//blog202307032252841.webp alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>.
</span></span><span style=display:flex><span>└── public <span style=color:#75715e># public 是默认的数据库模式（schema）。一个数据库可以包含多个模式，而每个模式又可以包含多个表、视图、函数等对象.schema 是一种逻辑容器，用于组织和管理数据库对象。它可以帮助在一个数据库中对不同的对象进行分类和分组</span>
</span></span><span style=display:flex><span>    ├── Tables <span style=color:#75715e># 表是存储数据的基本对象，类似于电子表格或数据库中的表格。它们由行和列组成，用于存储和组织数据</span>
</span></span><span style=display:flex><span>    ├── Views <span style=color:#75715e># 视图是虚拟表，是根据存储在其他表中的数据定义的查询结果。视图可以简化复杂查询，并提供一种方式来访问和使用数据</span>
</span></span><span style=display:flex><span>    ├── Materialized Views <span style=color:#75715e># 材料化视图是一种特殊类型的视图，它在创建时将查询结果缓存为实际的表。与普通视图不同，材料化视图的内容在查询时不会再次计算，而是使用预先计算的结果</span>
</span></span><span style=display:flex><span>    ├── Functions <span style=color:#75715e># 函数是一段封装了特定功能的可重用代码块。在数据库中，函数用于执行特定的计算、处理数据或返回结果</span>
</span></span><span style=display:flex><span>    ├── Queries
</span></span><span style=display:flex><span>    └── Backups
</span></span></code></pre></div><h3 id=解决数据库增长过快的问题到底解决了没有呢>解决数据库增长过快的问题（到底解决了没有呢？）</h3><p>前提：备份数据库</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 备份</span>
</span></span><span style=display:flex><span>mkdir -p /pleromabackup
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>777</span> /pleromabackup
</span></span><span style=display:flex><span>su - postgres
</span></span><span style=display:flex><span>psql -U postgres
</span></span><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># \! pg_dump pleroma -f /pleromabackup/pleroma.pgdump</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 检查备份目录大小</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>xxx@xxx pleromabackup<span style=color:#f92672>]</span><span style=color:#75715e># du -hs</span>
</span></span><span style=display:flex><span>341M    .
</span></span></code></pre></div><p>🌟 **查询所有表的行数：**创建一个 <code>count_em_all</code> 函数，然后调用它获得准确的统计信息</p><ol><li>创建：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> table_count <span style=color:#66d9ef>AS</span> (table_name TEXT, num_rows INTEGER); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> count_em_all () <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>SETOF</span> table_count  <span style=color:#66d9ef>AS</span> <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>DECLARE 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    the_count RECORD; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    t_name RECORD; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    r table_count%ROWTYPE; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>BEGIN
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FOR t_name IN 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c.relname
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            pg_catalog.pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WHERE 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c.relkind = &#39;&#39;r&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            AND n.nspname = &#39;&#39;public&#39;&#39; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ORDER BY 1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        LOOP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FOR the_count IN EXECUTE &#39;&#39;SELECT COUNT(*) AS &#34;count&#34; FROM &#39;&#39; || t_name.relname 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LOOP 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            END LOOP; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            r.table_name := t_name.relname; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            r.num_rows := the_count.count; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            RETURN NEXT r; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        END LOOP; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        RETURN; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>END;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql; 
</span></span></code></pre></div><ol start=2><li>调用</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>	count_em_all ( ) <span style=color:#66d9ef>AS</span> r 
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>	r<span style=color:#ae81ff>.</span>num_rows <span style=color:#66d9ef>DESC</span>;
</span></span></code></pre></div><p>结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>                 table_name                 <span style=color:#f92672>|</span> num_rows
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------+----------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> activities                                 <span style=color:#f92672>|</span>   <span style=color:#ae81ff>171772</span>
</span></span><span style=display:flex><span> objects                                    <span style=color:#f92672>|</span>   <span style=color:#ae81ff>120664</span>
</span></span><span style=display:flex><span> hashtags_objects                           <span style=color:#f92672>|</span>    <span style=color:#ae81ff>38433</span>
</span></span><span style=display:flex><span> users                                      <span style=color:#f92672>|</span>    <span style=color:#ae81ff>22054</span>
</span></span><span style=display:flex><span> hashtags                                   <span style=color:#f92672>|</span>     <span style=color:#ae81ff>7719</span>
</span></span><span style=display:flex><span> deliveries                                 <span style=color:#f92672>|</span>     <span style=color:#ae81ff>5420</span>
</span></span><span style=display:flex><span> counter_cache                              <span style=color:#f92672>|</span>      <span style=color:#ae81ff>876</span>
</span></span><span style=display:flex><span> notifications                              <span style=color:#f92672>|</span>      <span style=color:#ae81ff>570</span>
</span></span><span style=display:flex><span> oauth_authorizations                       <span style=color:#f92672>|</span>      <span style=color:#ae81ff>479</span>
</span></span><span style=display:flex><span> oauth_tokens                               <span style=color:#f92672>|</span>      <span style=color:#ae81ff>474</span>
</span></span><span style=display:flex><span> following_relationships                    <span style=color:#f92672>|</span>      <span style=color:#ae81ff>472</span>
</span></span><span style=display:flex><span> schema_migrations                          <span style=color:#f92672>|</span>      <span style=color:#ae81ff>302</span>
</span></span><span style=display:flex><span> apps                                       <span style=color:#f92672>|</span>       <span style=color:#ae81ff>83</span>
</span></span><span style=display:flex><span> user_relationships                         <span style=color:#f92672>|</span>       <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span> conversation_participation_recipient_ships <span style=color:#f92672>|</span>       <span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span> instances                                  <span style=color:#f92672>|</span>       <span style=color:#ae81ff>34</span>
</span></span><span style=display:flex><span> oban_jobs                                  <span style=color:#f92672>|</span>       <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span> conversation_participations                <span style=color:#f92672>|</span>       <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span> conversations                              <span style=color:#f92672>|</span>       <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> config                                     <span style=color:#f92672>|</span>       <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> bookmarks                                  <span style=color:#f92672>|</span>        <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span> markers                                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span> user_notes                                 <span style=color:#f92672>|</span>        <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> data_migrations                            <span style=color:#f92672>|</span>        <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> backups                                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> moderation_log                             <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> password_reset_tokens                      <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> lists                                      <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> oban_peers                                 <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> announcements                              <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> filters                                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> announcement_read_relationships            <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> data_migration_failed_ids                  <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> mfa_tokens                                 <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> chats                                      <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> chat_message_references                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> push_subscriptions                         <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> registrations                              <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> report_notes                               <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> scheduled_activities                       <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> thread_mutes                               <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> user_invite_tokens                         <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>42</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>🌟 <strong>查询所有表的总大小</strong>（括表数据文件、索引文件、TOAST表、Free Space Map等对象的大小）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>SELECT</span> relname, pg_size_pretty(pg_total_relation_size(relid)) <span style=color:#66d9ef>AS</span> size_mb
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> pg_stat_user_tables
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> pg_total_relation_size(relid) <span style=color:#66d9ef>DESC</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                  relname                   <span style=color:#f92672>|</span> size_mb 
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------+---------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> objects                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>266</span> MB
</span></span><span style=display:flex><span> activities                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>258</span> MB
</span></span><span style=display:flex><span> oban_jobs                                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>100</span> MB
</span></span><span style=display:flex><span> users                                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>64</span> MB
</span></span><span style=display:flex><span> hashtags_objects                           <span style=color:#f92672>|</span> <span style=color:#ae81ff>4096</span> kB
</span></span><span style=display:flex><span> hashtags                                   <span style=color:#f92672>|</span> <span style=color:#ae81ff>1288</span> kB
</span></span><span style=display:flex><span> deliveries                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>960</span> kB
</span></span><span style=display:flex><span> oauth_tokens                               <span style=color:#f92672>|</span> <span style=color:#ae81ff>592</span> kB
</span></span><span style=display:flex><span> oauth_authorizations                       <span style=color:#f92672>|</span> <span style=color:#ae81ff>344</span> kB
</span></span><span style=display:flex><span> notifications                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>240</span> kB
</span></span><span style=display:flex><span> following_relationships                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>232</span> kB
</span></span><span style=display:flex><span> counter_cache                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>208</span> kB
</span></span><span style=display:flex><span> apps                                       <span style=color:#f92672>|</span> <span style=color:#ae81ff>176</span> kB
</span></span><span style=display:flex><span> instances                                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>96</span> kB
</span></span><span style=display:flex><span> conversation_participations                <span style=color:#f92672>|</span> <span style=color:#ae81ff>88</span> kB
</span></span><span style=display:flex><span> lists                                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>80</span> kB
</span></span><span style=display:flex><span> markers                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>80</span> kB
</span></span><span style=display:flex><span> oban_peers                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>80</span> kB
</span></span><span style=display:flex><span> schema_migrations                          <span style=color:#f92672>|</span> <span style=color:#ae81ff>64</span> kB
</span></span><span style=display:flex><span> conversation_participation_recipient_ships <span style=color:#f92672>|</span> <span style=color:#ae81ff>56</span> kB
</span></span><span style=display:flex><span> user_relationships                         <span style=color:#f92672>|</span> <span style=color:#ae81ff>56</span> kB
</span></span><span style=display:flex><span> data_migrations                            <span style=color:#f92672>|</span> <span style=color:#ae81ff>48</span> kB
</span></span><span style=display:flex><span> config                                     <span style=color:#f92672>|</span> <span style=color:#ae81ff>48</span> kB
</span></span><span style=display:flex><span> backups                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>48</span> kB
</span></span><span style=display:flex><span> conversations                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>40</span> kB
</span></span><span style=display:flex><span> bookmarks                                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>40</span> kB
</span></span><span style=display:flex><span> user_notes                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>40</span> kB
</span></span><span style=display:flex><span> filters                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> scheduled_activities                       <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> registrations                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> chat_message_references                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> moderation_log                             <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> password_reset_tokens                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>24</span> kB
</span></span><span style=display:flex><span> push_subscriptions                         <span style=color:#f92672>|</span> <span style=color:#ae81ff>24</span> kB
</span></span><span style=display:flex><span> user_invite_tokens                         <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> mfa_tokens                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> announcement_read_relationships            <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> thread_mutes                               <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> announcements                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> report_notes                               <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> chats                                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> data_migration_failed_ids                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>42</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>列出行数和 size 排前五的表</p><p>🌟 <strong>activities 表</strong></p><p>type 字段的所有值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;type&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> activities;
</span></span><span style=display:flex><span>  <span style=color:#f92672>?</span><span style=color:#66d9ef>column</span><span style=color:#f92672>?</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Follow
</span></span><span style=display:flex><span> Block
</span></span><span style=display:flex><span> Announce
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Move</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Delete</span>
</span></span><span style=display:flex><span> Undo
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Create</span>
</span></span><span style=display:flex><span> EmojiReact
</span></span><span style=display:flex><span> Remove
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Update</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Like</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Add</span>
</span></span><span style=display:flex><span> Reject
</span></span><span style=display:flex><span> Accept
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>14</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>列出值是 Announce 的所有行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> activities <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Announce&#39;</span>;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#ae81ff>.</span><span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>pleroma_ctl <span style=color:#66d9ef>database</span> <span style=color:#66d9ef>vacuum</span> <span style=color:#66d9ef>full</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;actor&#34;</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>type</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;updated_at&#34;</span>, o<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;activities&#34;</span> <span style=color:#66d9ef>AS</span> a 
</span></span><span style=display:flex><span><span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#e6db74>&#34;objects&#34;</span> <span style=color:#66d9ef>AS</span> o
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> (o<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>COALESCE</span>(a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;object&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;to&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;cc&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;updated_at&#34;</span>;
</span></span></code></pre></div><p>🌟 users 表里有很多很多只有 nickname 的用户，它们所在实例是真实的，但是 ID 不是，我把这些行删了，暂时还没出问题</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>name</span> <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>name</span> <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span></code></pre></div><p>🌟 删除了一个 bot 的记录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://xx.ca/users/xxxBot&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://xx.ca/users/xxxBot&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>485</span>
</span></span></code></pre></div><p>🌟 删除了 activities 表 2023-06-15 之前、与我无讨论关系、书签以外的内容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> activities 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> activity_id <span style=color:#66d9ef>FROM</span> bookmarks) 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> inserted_at <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#39;2023-06-15&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> id <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> a<span style=color:#ae81ff>.</span>id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> activities <span style=color:#66d9ef>AS</span> a
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> objects <span style=color:#66d9ef>AS</span> o <span style=color:#66d9ef>ON</span> (o<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>COALESCE</span>(a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;object&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;to&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;cc&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>89430</span>
</span></span></code></pre></div><p>🌟 删除了 objects 表与以上内容对应的行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>创建一个临时表 temp_objects 
</span></span></span><span style=display:flex><span><span style=color:#75715e>来存储那些在 activities 表中找不到对应行的 objects 表的行
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TEMPORARY</span> <span style=color:#66d9ef>TABLE</span> temp_objects <span style=color:#66d9ef>AS</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> o<span style=color:#ae81ff>.</span><span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> objects o
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> activities a <span style=color:#66d9ef>ON</span> o<span style=color:#ae81ff>.</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span> <span style=color:#f92672>=</span> a<span style=color:#ae81ff>.</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> a<span style=color:#ae81ff>.</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span> <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>128652</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>报错：
</span></span></span><span style=display:flex><span><span style=color:#75715e>执行删除操作时违反了外键约束
</span></span></span><span style=display:flex><span><span style=color:#75715e>objects 表中的某些行仍然被 deliveries 表引用，因此无法直接删除
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>deliveries 表是用于跟踪消息传递的表，通常在 ActivityPub 协议的实现中使用
</span></span></span><span style=display:flex><span><span style=color:#75715e>它记录了消息传递的相关信息，例如发送方、接收方、消息内容等
</span></span></span><span style=display:flex><span><span style=color:#75715e>每条记录代表一次消息传递或交互。
</span></span></span><span style=display:flex><span><span style=color:#75715e>在 Pleroma 中，deliveries 表用于存储消息的传递状态和相关信息，以确保消息能够正确地传递给目标用户
</span></span></span><span style=display:flex><span><span style=color:#75715e>它与 objects 表和 activities 表之间可能存在外键关系，用于保证数据的完整性
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> temp_objects);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ERROR:  <span style=color:#66d9ef>update</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>table</span> <span style=color:#e6db74>&#34;objects&#34;</span> violates <span style=color:#66d9ef>foreign</span> <span style=color:#66d9ef>key</span> <span style=color:#66d9ef>constraint</span> <span style=color:#e6db74>&#34;deliveries_object_id_fkey&#34;</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>table</span> <span style=color:#e6db74>&#34;deliveries&#34;</span>
</span></span><span style=display:flex><span>DETAIL:  <span style=color:#66d9ef>Key</span> (id)<span style=color:#f92672>=</span>(<span style=color:#ae81ff>75072</span>) <span style=color:#66d9ef>is</span> still referenced <span style=color:#66d9ef>from</span> <span style=color:#66d9ef>table</span> <span style=color:#e6db74>&#34;deliveries&#34;</span><span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>所以先删除被 deliveries 表引用的行
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> deliveries
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> user_id <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> activities);
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>6372</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>继续执行删除操作并删除临时表
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> temp_objects);
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>128652</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> temp_objects;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span>
</span></span></code></pre></div><p>最后 <code>su pleroma -s $SHELL -lc "./bin/pleroma_ctl database vacuum full "</code>，但是！SQL 命令有问题，删了我好多嘟，呜呜呜哭着倒地。重新看了一下数据库大小，现在倒是变得迷你了，164 MB。但是这一切真的值得吗……完全在我计划外的……</p><h3 id=常用-psql-命令>常用 psql 命令</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>psql <span style=color:#f92672>-</span>U postgres <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>指定用户连接</span>PostgreSQL
</span></span><span style=display:flex><span>psql <span style=color:#f92672>-</span>d postgres <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>指定数据库连接</span>PostgreSQL
</span></span><span style=display:flex><span>psql <span style=color:#f92672>-</span>h <span style=color:#ae81ff>127.0.0.1</span> <span style=color:#f92672>-</span>p <span style=color:#ae81ff>5432</span> <span style=color:#f92672>-</span>U pg <span style=color:#f92672>-</span>d postgres <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>连接到本地主机（</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#960050;background-color:#1e0010>）的</span> PostgreSQL <span style=color:#960050;background-color:#1e0010>数据库服务器，使用用户名</span> pg <span style=color:#960050;background-color:#1e0010>连接到名为</span> postgres <span style=color:#960050;background-color:#1e0010>的数据库</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>du <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>查看所有用户</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>l <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>查看所有数据库</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>c{dbname} <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>切换到数据库</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>dt <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>查看当前数据库的所有表</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>d {tablename} <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>查看指定表</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> data_directory; <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>查看数据目录</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>q <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>退出交互查询模式</span>
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/postgresql>postgresql</a></li><li><a href=/tags/tech>tech</a></li><li><a href=/tags/database>database</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/falasool/ rel=me title=GitHub><i data-feather=github></i></a></div><div class=footer-info>2024 © Falaool | Built with <a href=https://gohugo.io>Hugo</a> & Theme <a href=https://github.com/athul/archie>Archie</a> design by Athul</div></footer><script>feather.replace()</script></div></body></html>
<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>åˆé‡ PostgreSQL - Falasool</title><link rel=icon type=image/png href=static/img/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ä»¥ç°æœ‰ Pleroma æ•°æ®åº“ä¸ºåŸºç¡€å­¦ä¹  postgreSQL æœ¬åœ°å®‰è£… PG ç”¨ Homebrew å®‰è£… brew install postgresql@13 æ·»åŠ ç¯å¢ƒå˜é‡ # ~/.zshrc + # PostgreSQL + export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34; + export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34; è®©ä¿®æ”¹ç”Ÿæ•ˆ & æµ‹è¯• source ~/.zshrc # å¯¹é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ç”Ÿæ•ˆ pg_ctl -V # æŸ¥çœ‹ç‰ˆæœ¬"><meta property="og:image" content><meta property="og:title" content="åˆé‡ PostgreSQL"><meta property="og:description" content="ä»¥ç°æœ‰ Pleroma æ•°æ®åº“ä¸ºåŸºç¡€å­¦ä¹  postgreSQL æœ¬åœ°å®‰è£… PG ç”¨ Homebrew å®‰è£… brew install postgresql@13 æ·»åŠ ç¯å¢ƒå˜é‡ # ~/.zshrc + # PostgreSQL + export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34; + export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34; è®©ä¿®æ”¹ç”Ÿæ•ˆ & æµ‹è¯• source ~/.zshrc # å¯¹é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ç”Ÿæ•ˆ pg_ctl -V # æŸ¥çœ‹ç‰ˆæœ¬"><meta property="og:type" content="article"><meta property="og:url" content="https://falasool.github.io/posts/postgresql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-26T11:21:32+08:00"><meta property="article:modified_time" content="2023-06-26T11:21:32+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="åˆé‡ PostgreSQL"><meta name=twitter:description content="ä»¥ç°æœ‰ Pleroma æ•°æ®åº“ä¸ºåŸºç¡€å­¦ä¹  postgreSQL æœ¬åœ°å®‰è£… PG ç”¨ Homebrew å®‰è£… brew install postgresql@13 æ·»åŠ ç¯å¢ƒå˜é‡ # ~/.zshrc + # PostgreSQL + export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34; + export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34; è®©ä¿®æ”¹ç”Ÿæ•ˆ & æµ‹è¯• source ~/.zshrc # å¯¹é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ç”Ÿæ•ˆ pg_ctl -V # æŸ¥çœ‹ç‰ˆæœ¬"><script src=https://falasool.github.io/js/feather.min.js></script>
<link href=https://falasool.github.io/css/fonts.4bacf4386d3f58fdc378d205a903311c80158bf414d25698589b658e0273156d.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://falasool.github.io/css/main.a562939875f5647d4bcd33af2971cc96f9630e2452c4aa7c92f5f25e14077830.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://falasool.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://falasool.github.io/>Falasool</a></div><nav><a href=/friends/></a>
<a href=/about>About</a>
<a href=/friends>Friends</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>åˆé‡ PostgreSQL</h1><div class=meta>Posted on Jun 26, 2023</div></div><section class=body><p>ä»¥ç°æœ‰ Pleroma æ•°æ®åº“ä¸ºåŸºç¡€å­¦ä¹  postgreSQL</p><h2 id=æœ¬åœ°å®‰è£…-pg>æœ¬åœ°å®‰è£… PG</h2><h3 id=ç”¨-homebrew-å®‰è£…>ç”¨ Homebrew å®‰è£…</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>brew install postgresql@13
</span></span></code></pre></div><p>æ·»åŠ ç¯å¢ƒå˜é‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># ~/.zshrc
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ # PostgreSQL
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ export PATH=&#34;/opt/homebrew/Cellar/postgresql@13/13.11_1/bin:$PATH&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ export PGDATA=&#34;/opt/homebrew/var/postgresql@13&#34;
</span></span></span></code></pre></div><p>è®©ä¿®æ”¹ç”Ÿæ•ˆ & æµ‹è¯•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>source ~/.zshrc <span style=color:#75715e># å¯¹é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ç”Ÿæ•ˆ</span>
</span></span><span style=display:flex><span>pg_ctl -V <span style=color:#75715e># æŸ¥çœ‹ç‰ˆæœ¬ï¼Œreturn `pg_ctl (PostgreSQL) 13.1` </span>
</span></span></code></pre></div><h3 id=dmg-å®‰è£…>dmg å®‰è£…</h3><p><a href=https://www.enterprisedb.com/downloads/postgres-postgresql-downloads>ä¸‹è½½</a></p><p>ä¿®æ”¹ç¯å¢ƒå˜é‡</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># PostgreSQL</span>
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/Library/PostgreSQL/13/bin:</span>$PATH<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>source ~/.zshrc
</span></span></code></pre></div><h2 id=è¿œç¨‹æ“ä½œ-pg>è¿œç¨‹æ“ä½œ PG</h2><h3 id=ç™»å½•>ç™»å½•</h3><p>å…è®¸è¿œç¨‹ç™»å½•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>locate postgresql.conf <span style=color:#75715e># å®šä½æ–‡ä»¶ä½ç½®</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># /etc/postgresql/13/main/postgresql.conf </span>
</span></span><span style=display:flex><span>listen_addresses <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;*&#39;</span> <span style=color:#75715e># ä¿®æ”¹å†…å®¹</span>
</span></span></code></pre></div><p>æ·»åŠ å®¢æˆ·ç«¯é‰´å®šæ¡ç›®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># /etc/postgresql/13/main/pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#75715e># å…è®¸ç”¨æˆ·åœ¨æä¾›æœ‰æ•ˆå£ä»¤ï¼ˆmd5ï¼‰åä»æŸä¸ª IP åœ°å€ç™»å½•</span>
</span></span><span style=display:flex><span>host all all 0.0.0.0/0 md5
</span></span><span style=display:flex><span>host all all ::0/0 md5
</span></span></code></pre></div><p>[å¯é€‰]ä¿®æ”¹å¯†ç </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># alter user postgres with password &#39;xxxxxxxx&#39;;</span>
</span></span><span style=display:flex><span>ALTER ROLE
</span></span></code></pre></div><p>æœ€åé‡å¯ pg</p><p>ä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥ï¼ˆä¹Ÿè®¸ä»¥åå°±çŸ¥é“äº†ï¼‰æˆ‘å¼€å¯ 5432 ç«¯å£æ— æ•ˆï¼šufw å‘½ä»¤è¿”å›ç»“æœæ˜¾ç¤ºå·²å¼€å¯ï¼Œé˜²ç«å¢™è§„åˆ™æ·»åŠ äº†ï¼Œip æ£€æŸ¥å·¥å…·è¿˜æ˜¯æ˜¾ç¤ºç«¯å£æœªå¼€æ”¾ã€‚ç„¶åé»›é»›æ•™äº†æˆ‘ç«¯å£è½¬å‘</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ssh -L 127.0.0.1:5432:127.0.0.1:5432 username@hostname
</span></span></code></pre></div><p>è¿ä¸Šä¹‹åä¿æŒæ‰“å¼€è¿™ä¸ªçª—å£ï¼Œæˆ‘ç”¨ Navicat è¿ä¸Šäº†æ•°æ®åº“ï¼Œç¬¬ä¸€æ¬¡è§åˆ°äº†æ•°æ®åº“åˆ°åº•æ˜¯å•¥ç»“æ„â€¦â€¦ï¼ˆNavicat æ˜¯ä»€ä¹ˆè¯·çœ‹ <a href=https://www.navicat.com.cn/manual/online_manual/cn/navicat_16/win_manual/#/main_window>ç”¨æˆ·æ‰‹å†Œ</a>ï¼‰</p><p><img src=https://cdn.jsdelivr.net/gh/Falasool/blog-pic-bed@main//blog202307032252841.webp alt=image></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>.
</span></span><span style=display:flex><span>â””â”€â”€ public <span style=color:#75715e># public æ˜¯é»˜è®¤çš„æ•°æ®åº“æ¨¡å¼ï¼ˆschemaï¼‰ã€‚ä¸€ä¸ªæ•°æ®åº“å¯ä»¥åŒ…å«å¤šä¸ªæ¨¡å¼ï¼Œè€Œæ¯ä¸ªæ¨¡å¼åˆå¯ä»¥åŒ…å«å¤šä¸ªè¡¨ã€è§†å›¾ã€å‡½æ•°ç­‰å¯¹è±¡.schema æ˜¯ä¸€ç§é€»è¾‘å®¹å™¨ï¼Œç”¨äºç»„ç»‡å’Œç®¡ç†æ•°æ®åº“å¯¹è±¡ã€‚å®ƒå¯ä»¥å¸®åŠ©åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸­å¯¹ä¸åŒçš„å¯¹è±¡è¿›è¡Œåˆ†ç±»å’Œåˆ†ç»„</span>
</span></span><span style=display:flex><span>    â”œâ”€â”€ Tables <span style=color:#75715e># è¡¨æ˜¯å­˜å‚¨æ•°æ®çš„åŸºæœ¬å¯¹è±¡ï¼Œç±»ä¼¼äºç”µå­è¡¨æ ¼æˆ–æ•°æ®åº“ä¸­çš„è¡¨æ ¼ã€‚å®ƒä»¬ç”±è¡Œå’Œåˆ—ç»„æˆï¼Œç”¨äºå­˜å‚¨å’Œç»„ç»‡æ•°æ®</span>
</span></span><span style=display:flex><span>    â”œâ”€â”€ Views <span style=color:#75715e># è§†å›¾æ˜¯è™šæ‹Ÿè¡¨ï¼Œæ˜¯æ ¹æ®å­˜å‚¨åœ¨å…¶ä»–è¡¨ä¸­çš„æ•°æ®å®šä¹‰çš„æŸ¥è¯¢ç»“æœã€‚è§†å›¾å¯ä»¥ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼Œå¹¶æä¾›ä¸€ç§æ–¹å¼æ¥è®¿é—®å’Œä½¿ç”¨æ•°æ®</span>
</span></span><span style=display:flex><span>    â”œâ”€â”€ Materialized Views <span style=color:#75715e># ææ–™åŒ–è§†å›¾æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„è§†å›¾ï¼Œå®ƒåœ¨åˆ›å»ºæ—¶å°†æŸ¥è¯¢ç»“æœç¼“å­˜ä¸ºå®é™…çš„è¡¨ã€‚ä¸æ™®é€šè§†å›¾ä¸åŒï¼Œææ–™åŒ–è§†å›¾çš„å†…å®¹åœ¨æŸ¥è¯¢æ—¶ä¸ä¼šå†æ¬¡è®¡ç®—ï¼Œè€Œæ˜¯ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„ç»“æœ</span>
</span></span><span style=display:flex><span>    â”œâ”€â”€ Functions <span style=color:#75715e># å‡½æ•°æ˜¯ä¸€æ®µå°è£…äº†ç‰¹å®šåŠŸèƒ½çš„å¯é‡ç”¨ä»£ç å—ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œå‡½æ•°ç”¨äºæ‰§è¡Œç‰¹å®šçš„è®¡ç®—ã€å¤„ç†æ•°æ®æˆ–è¿”å›ç»“æœ</span>
</span></span><span style=display:flex><span>    â”œâ”€â”€ Queries
</span></span><span style=display:flex><span>  Â  â””â”€â”€ Backups
</span></span></code></pre></div><h3 id=è§£å†³æ•°æ®åº“å¢é•¿è¿‡å¿«çš„é—®é¢˜åˆ°åº•è§£å†³äº†æ²¡æœ‰å‘¢>è§£å†³æ•°æ®åº“å¢é•¿è¿‡å¿«çš„é—®é¢˜ï¼ˆåˆ°åº•è§£å†³äº†æ²¡æœ‰å‘¢ï¼Ÿï¼‰</h3><p>å‰æï¼šå¤‡ä»½æ•°æ®åº“</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># å¤‡ä»½</span>
</span></span><span style=display:flex><span>mkdir -p /pleromabackup
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>777</span> /pleromabackup
</span></span><span style=display:flex><span>su - postgres
</span></span><span style=display:flex><span>psql -U postgres
</span></span><span style=display:flex><span>postgres<span style=color:#f92672>=</span><span style=color:#75715e># \! pg_dump pleroma -f /pleromabackup/pleroma.pgdump</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ£€æŸ¥å¤‡ä»½ç›®å½•å¤§å°</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>xxx@xxx pleromabackup<span style=color:#f92672>]</span><span style=color:#75715e># du -hs</span>
</span></span><span style=display:flex><span>341M    .
</span></span></code></pre></div><p>ğŸŒŸ **æŸ¥è¯¢æ‰€æœ‰è¡¨çš„è¡Œæ•°ï¼š**åˆ›å»ºä¸€ä¸ª <code>count_em_all</code> å‡½æ•°ï¼Œç„¶åè°ƒç”¨å®ƒè·å¾—å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯</p><ol><li>åˆ›å»ºï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TYPE</span> table_count <span style=color:#66d9ef>AS</span> (table_name TEXT, num_rows INTEGER); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>FUNCTION</span> count_em_all () <span style=color:#66d9ef>RETURNS</span> <span style=color:#66d9ef>SETOF</span> table_count  <span style=color:#66d9ef>AS</span> <span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>DECLARE 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    the_count RECORD; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    t_name RECORD; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    r table_count%ROWTYPE; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>BEGIN
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    FOR t_name IN 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c.relname
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            pg_catalog.pg_class c LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WHERE 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            c.relkind = &#39;&#39;r&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            AND n.nspname = &#39;&#39;public&#39;&#39; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ORDER BY 1 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        LOOP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FOR the_count IN EXECUTE &#39;&#39;SELECT COUNT(*) AS &#34;count&#34; FROM &#39;&#39; || t_name.relname 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LOOP 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            END LOOP; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            r.table_name := t_name.relname; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            r.num_rows := the_count.count; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            RETURN NEXT r; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        END LOOP; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        RETURN; 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>END;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;</span> <span style=color:#66d9ef>LANGUAGE</span> plpgsql; 
</span></span></code></pre></div><ol start=2><li>è°ƒç”¨</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>*</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>	count_em_all ( ) <span style=color:#66d9ef>AS</span> r 
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span>
</span></span><span style=display:flex><span>	r<span style=color:#ae81ff>.</span>num_rows <span style=color:#66d9ef>DESC</span>;
</span></span></code></pre></div><p>ç»“æœï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>                 table_name                 <span style=color:#f92672>|</span> num_rows
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------+----------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> activities                                 <span style=color:#f92672>|</span>   <span style=color:#ae81ff>171772</span>
</span></span><span style=display:flex><span> objects                                    <span style=color:#f92672>|</span>   <span style=color:#ae81ff>120664</span>
</span></span><span style=display:flex><span> hashtags_objects                           <span style=color:#f92672>|</span>    <span style=color:#ae81ff>38433</span>
</span></span><span style=display:flex><span> users                                      <span style=color:#f92672>|</span>    <span style=color:#ae81ff>22054</span>
</span></span><span style=display:flex><span> hashtags                                   <span style=color:#f92672>|</span>     <span style=color:#ae81ff>7719</span>
</span></span><span style=display:flex><span> deliveries                                 <span style=color:#f92672>|</span>     <span style=color:#ae81ff>5420</span>
</span></span><span style=display:flex><span> counter_cache                              <span style=color:#f92672>|</span>      <span style=color:#ae81ff>876</span>
</span></span><span style=display:flex><span> notifications                              <span style=color:#f92672>|</span>      <span style=color:#ae81ff>570</span>
</span></span><span style=display:flex><span> oauth_authorizations                       <span style=color:#f92672>|</span>      <span style=color:#ae81ff>479</span>
</span></span><span style=display:flex><span> oauth_tokens                               <span style=color:#f92672>|</span>      <span style=color:#ae81ff>474</span>
</span></span><span style=display:flex><span> following_relationships                    <span style=color:#f92672>|</span>      <span style=color:#ae81ff>472</span>
</span></span><span style=display:flex><span> schema_migrations                          <span style=color:#f92672>|</span>      <span style=color:#ae81ff>302</span>
</span></span><span style=display:flex><span> apps                                       <span style=color:#f92672>|</span>       <span style=color:#ae81ff>83</span>
</span></span><span style=display:flex><span> user_relationships                         <span style=color:#f92672>|</span>       <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span> conversation_participation_recipient_ships <span style=color:#f92672>|</span>       <span style=color:#ae81ff>36</span>
</span></span><span style=display:flex><span> instances                                  <span style=color:#f92672>|</span>       <span style=color:#ae81ff>34</span>
</span></span><span style=display:flex><span> oban_jobs                                  <span style=color:#f92672>|</span>       <span style=color:#ae81ff>32</span>
</span></span><span style=display:flex><span> conversation_participations                <span style=color:#f92672>|</span>       <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span> conversations                              <span style=color:#f92672>|</span>       <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> config                                     <span style=color:#f92672>|</span>       <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span> bookmarks                                  <span style=color:#f92672>|</span>        <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span> markers                                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span> user_notes                                 <span style=color:#f92672>|</span>        <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> data_migrations                            <span style=color:#f92672>|</span>        <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span> backups                                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> moderation_log                             <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> password_reset_tokens                      <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> lists                                      <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> oban_peers                                 <span style=color:#f92672>|</span>        <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> announcements                              <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> filters                                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> announcement_read_relationships            <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> data_migration_failed_ids                  <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> mfa_tokens                                 <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> chats                                      <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> chat_message_references                    <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> push_subscriptions                         <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> registrations                              <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> report_notes                               <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> scheduled_activities                       <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> thread_mutes                               <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span> user_invite_tokens                         <span style=color:#f92672>|</span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>42</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>ğŸŒŸ <strong>æŸ¥è¯¢æ‰€æœ‰è¡¨çš„æ€»å¤§å°</strong>ï¼ˆæ‹¬è¡¨æ•°æ®æ–‡ä»¶ã€ç´¢å¼•æ–‡ä»¶ã€TOASTè¡¨ã€Free Space Mapç­‰å¯¹è±¡çš„å¤§å°ï¼‰</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>SELECT</span> relname, pg_size_pretty(pg_total_relation_size(relid)) <span style=color:#66d9ef>AS</span> size_mb
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> pg_stat_user_tables
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> pg_total_relation_size(relid) <span style=color:#66d9ef>DESC</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                  relname                   <span style=color:#f92672>|</span> size_mb 
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------+---------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> objects                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>266</span> MB
</span></span><span style=display:flex><span> activities                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>258</span> MB
</span></span><span style=display:flex><span> oban_jobs                                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>100</span> MB
</span></span><span style=display:flex><span> users                                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>64</span> MB
</span></span><span style=display:flex><span> hashtags_objects                           <span style=color:#f92672>|</span> <span style=color:#ae81ff>4096</span> kB
</span></span><span style=display:flex><span> hashtags                                   <span style=color:#f92672>|</span> <span style=color:#ae81ff>1288</span> kB
</span></span><span style=display:flex><span> deliveries                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>960</span> kB
</span></span><span style=display:flex><span> oauth_tokens                               <span style=color:#f92672>|</span> <span style=color:#ae81ff>592</span> kB
</span></span><span style=display:flex><span> oauth_authorizations                       <span style=color:#f92672>|</span> <span style=color:#ae81ff>344</span> kB
</span></span><span style=display:flex><span> notifications                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>240</span> kB
</span></span><span style=display:flex><span> following_relationships                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>232</span> kB
</span></span><span style=display:flex><span> counter_cache                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>208</span> kB
</span></span><span style=display:flex><span> apps                                       <span style=color:#f92672>|</span> <span style=color:#ae81ff>176</span> kB
</span></span><span style=display:flex><span> instances                                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>96</span> kB
</span></span><span style=display:flex><span> conversation_participations                <span style=color:#f92672>|</span> <span style=color:#ae81ff>88</span> kB
</span></span><span style=display:flex><span> lists                                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>80</span> kB
</span></span><span style=display:flex><span> markers                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>80</span> kB
</span></span><span style=display:flex><span> oban_peers                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>80</span> kB
</span></span><span style=display:flex><span> schema_migrations                          <span style=color:#f92672>|</span> <span style=color:#ae81ff>64</span> kB
</span></span><span style=display:flex><span> conversation_participation_recipient_ships <span style=color:#f92672>|</span> <span style=color:#ae81ff>56</span> kB
</span></span><span style=display:flex><span> user_relationships                         <span style=color:#f92672>|</span> <span style=color:#ae81ff>56</span> kB
</span></span><span style=display:flex><span> data_migrations                            <span style=color:#f92672>|</span> <span style=color:#ae81ff>48</span> kB
</span></span><span style=display:flex><span> config                                     <span style=color:#f92672>|</span> <span style=color:#ae81ff>48</span> kB
</span></span><span style=display:flex><span> backups                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>48</span> kB
</span></span><span style=display:flex><span> conversations                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>40</span> kB
</span></span><span style=display:flex><span> bookmarks                                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>40</span> kB
</span></span><span style=display:flex><span> user_notes                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>40</span> kB
</span></span><span style=display:flex><span> filters                                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> scheduled_activities                       <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> registrations                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> chat_message_references                    <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> moderation_log                             <span style=color:#f92672>|</span> <span style=color:#ae81ff>32</span> kB
</span></span><span style=display:flex><span> password_reset_tokens                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>24</span> kB
</span></span><span style=display:flex><span> push_subscriptions                         <span style=color:#f92672>|</span> <span style=color:#ae81ff>24</span> kB
</span></span><span style=display:flex><span> user_invite_tokens                         <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> mfa_tokens                                 <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> announcement_read_relationships            <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> thread_mutes                               <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> announcements                              <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> report_notes                               <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> chats                                      <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span> data_migration_failed_ids                  <span style=color:#f92672>|</span> <span style=color:#ae81ff>16</span> kB
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>42</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>åˆ—å‡ºè¡Œæ•°å’Œ size æ’å‰äº”çš„è¡¨</p><p>ğŸŒŸ <strong>activities è¡¨</strong></p><p>type å­—æ®µçš„æ‰€æœ‰å€¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;type&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> activities;
</span></span><span style=display:flex><span>  <span style=color:#f92672>?</span><span style=color:#66d9ef>column</span><span style=color:#f92672>?</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Follow
</span></span><span style=display:flex><span> Block
</span></span><span style=display:flex><span> Announce
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Move</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Delete</span>
</span></span><span style=display:flex><span> Undo
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Create</span>
</span></span><span style=display:flex><span> EmojiReact
</span></span><span style=display:flex><span> Remove
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Update</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Like</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>Add</span>
</span></span><span style=display:flex><span> Reject
</span></span><span style=display:flex><span> Accept
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>14</span> <span style=color:#66d9ef>rows</span>)
</span></span></code></pre></div><p>åˆ—å‡ºå€¼æ˜¯ Announce çš„æ‰€æœ‰è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> activities <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Announce&#39;</span>;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#ae81ff>.</span><span style=color:#f92672>/</span>bin<span style=color:#f92672>/</span>pleroma_ctl <span style=color:#66d9ef>database</span> <span style=color:#66d9ef>vacuum</span> <span style=color:#66d9ef>full</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;actor&#34;</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;type&#39;</span> <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>type</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;updated_at&#34;</span>, o<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;activities&#34;</span> <span style=color:#66d9ef>AS</span> a 
</span></span><span style=display:flex><span><span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#e6db74>&#34;objects&#34;</span> <span style=color:#66d9ef>AS</span> o
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> (o<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>COALESCE</span>(a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;object&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;to&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;cc&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://pleroma.your.site/users/admin&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;updated_at&#34;</span>;
</span></span></code></pre></div><p>ğŸŒŸ users è¡¨é‡Œæœ‰å¾ˆå¤šå¾ˆå¤šåªæœ‰ nickname çš„ç”¨æˆ·ï¼Œå®ƒä»¬æ‰€åœ¨å®ä¾‹æ˜¯çœŸå®çš„ï¼Œä½†æ˜¯ ID ä¸æ˜¯ï¼Œæˆ‘æŠŠè¿™äº›è¡Œåˆ äº†ï¼Œæš‚æ—¶è¿˜æ²¡å‡ºé—®é¢˜</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>name</span> <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>name</span> <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span></code></pre></div><p>ğŸŒŸ åˆ é™¤äº†ä¸€ä¸ª bot çš„è®°å½•</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://xx.ca/users/xxxBot&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://xx.ca/users/xxxBot&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>485</span>
</span></span></code></pre></div><p>ğŸŒŸ åˆ é™¤äº† activities è¡¨ 2023-06-15 ä¹‹å‰ã€ä¸æˆ‘æ— è®¨è®ºå…³ç³»ã€ä¹¦ç­¾ä»¥å¤–çš„å†…å®¹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> activities 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> activity_id <span style=color:#66d9ef>FROM</span> bookmarks) 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> inserted_at <span style=color:#f92672>&lt;</span> <span style=color:#e6db74>&#39;2023-06-15&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>AND</span> id <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> a<span style=color:#ae81ff>.</span>id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> activities <span style=color:#66d9ef>AS</span> a
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> objects <span style=color:#66d9ef>AS</span> o <span style=color:#66d9ef>ON</span> (o<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>COALESCE</span>(a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>, a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;object&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;actor&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;to&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>OR</span> a<span style=color:#ae81ff>.</span><span style=color:#e6db74>&#34;data&#34;</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;cc&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;https://ponderduck.cc/users/yaya&#39;</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>89430</span>
</span></span></code></pre></div><p>ğŸŒŸ åˆ é™¤äº† objects è¡¨ä¸ä»¥ä¸Šå†…å®¹å¯¹åº”çš„è¡Œ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ temp_objects 
</span></span></span><span style=display:flex><span><span style=color:#75715e>æ¥å­˜å‚¨é‚£äº›åœ¨ activities è¡¨ä¸­æ‰¾ä¸åˆ°å¯¹åº”è¡Œçš„ objects è¡¨çš„è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TEMPORARY</span> <span style=color:#66d9ef>TABLE</span> temp_objects <span style=color:#66d9ef>AS</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> o<span style=color:#ae81ff>.</span><span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> objects o
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> activities a <span style=color:#66d9ef>ON</span> o<span style=color:#ae81ff>.</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span> <span style=color:#f92672>=</span> a<span style=color:#ae81ff>.</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> a<span style=color:#ae81ff>.</span><span style=color:#66d9ef>data</span><span style=color:#f92672>-&gt;</span><span style=color:#e6db74>&#39;object&#39;</span><span style=color:#f92672>-&gt;&gt;</span><span style=color:#e6db74>&#39;id&#39;</span> <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>128652</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>æŠ¥é”™ï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e>æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶è¿åäº†å¤–é”®çº¦æŸ
</span></span></span><span style=display:flex><span><span style=color:#75715e>objects è¡¨ä¸­çš„æŸäº›è¡Œä»ç„¶è¢« deliveries è¡¨å¼•ç”¨ï¼Œå› æ­¤æ— æ³•ç›´æ¥åˆ é™¤
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>deliveries è¡¨æ˜¯ç”¨äºè·Ÿè¸ªæ¶ˆæ¯ä¼ é€’çš„è¡¨ï¼Œé€šå¸¸åœ¨ ActivityPub åè®®çš„å®ç°ä¸­ä½¿ç”¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>å®ƒè®°å½•äº†æ¶ˆæ¯ä¼ é€’çš„ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚å‘é€æ–¹ã€æ¥æ”¶æ–¹ã€æ¶ˆæ¯å†…å®¹ç­‰
</span></span></span><span style=display:flex><span><span style=color:#75715e>æ¯æ¡è®°å½•ä»£è¡¨ä¸€æ¬¡æ¶ˆæ¯ä¼ é€’æˆ–äº¤äº’ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e>åœ¨ Pleroma ä¸­ï¼Œdeliveries è¡¨ç”¨äºå­˜å‚¨æ¶ˆæ¯çš„ä¼ é€’çŠ¶æ€å’Œç›¸å…³ä¿¡æ¯ï¼Œä»¥ç¡®ä¿æ¶ˆæ¯èƒ½å¤Ÿæ­£ç¡®åœ°ä¼ é€’ç»™ç›®æ ‡ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#75715e>å®ƒä¸ objects è¡¨å’Œ activities è¡¨ä¹‹é—´å¯èƒ½å­˜åœ¨å¤–é”®å…³ç³»ï¼Œç”¨äºä¿è¯æ•°æ®çš„å®Œæ•´æ€§
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> temp_objects);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ERROR:  <span style=color:#66d9ef>update</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>delete</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>table</span> <span style=color:#e6db74>&#34;objects&#34;</span> violates <span style=color:#66d9ef>foreign</span> <span style=color:#66d9ef>key</span> <span style=color:#66d9ef>constraint</span> <span style=color:#e6db74>&#34;deliveries_object_id_fkey&#34;</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>table</span> <span style=color:#e6db74>&#34;deliveries&#34;</span>
</span></span><span style=display:flex><span>DETAIL:  <span style=color:#66d9ef>Key</span> (id)<span style=color:#f92672>=</span>(<span style=color:#ae81ff>75072</span>) <span style=color:#66d9ef>is</span> still referenced <span style=color:#66d9ef>from</span> <span style=color:#66d9ef>table</span> <span style=color:#e6db74>&#34;deliveries&#34;</span><span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>æ‰€ä»¥å…ˆåˆ é™¤è¢« deliveries è¡¨å¼•ç”¨çš„è¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> deliveries
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> user_id <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> activities);
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>6372</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>ç»§ç»­æ‰§è¡Œåˆ é™¤æ“ä½œå¹¶åˆ é™¤ä¸´æ—¶è¡¨
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> objects
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> id <span style=color:#66d9ef>IN</span> (<span style=color:#66d9ef>SELECT</span> id <span style=color:#66d9ef>FROM</span> temp_objects);
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELETE</span> <span style=color:#ae81ff>128652</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pleroma<span style=color:#f92672>=#</span> <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> temp_objects;
</span></span><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span>
</span></span></code></pre></div><p>æœ€å <code>su pleroma -s $SHELL -lc "./bin/pleroma_ctl database vacuum full "</code>ï¼Œä½†æ˜¯ï¼SQL å‘½ä»¤æœ‰é—®é¢˜ï¼Œåˆ äº†æˆ‘å¥½å¤šå˜Ÿï¼Œå‘œå‘œå‘œå“­ç€å€’åœ°ã€‚é‡æ–°çœ‹äº†ä¸€ä¸‹æ•°æ®åº“å¤§å°ï¼Œç°åœ¨å€’æ˜¯å˜å¾—è¿·ä½ äº†ï¼Œ164 MBã€‚ä½†æ˜¯è¿™ä¸€åˆ‡çœŸçš„å€¼å¾—å—â€¦â€¦å®Œå…¨åœ¨æˆ‘è®¡åˆ’å¤–çš„â€¦â€¦</p><h3 id=å¸¸ç”¨-psql-å‘½ä»¤>å¸¸ç”¨ psql å‘½ä»¤</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-postgresql data-lang=postgresql><span style=display:flex><span>psql <span style=color:#f92672>-</span>U postgres <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŒ‡å®šç”¨æˆ·è¿æ¥</span>PostgreSQL
</span></span><span style=display:flex><span>psql <span style=color:#f92672>-</span>d postgres <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŒ‡å®šæ•°æ®åº“è¿æ¥</span>PostgreSQL
</span></span><span style=display:flex><span>psql <span style=color:#f92672>-</span>h <span style=color:#ae81ff>127.0.0.1</span> <span style=color:#f92672>-</span>p <span style=color:#ae81ff>5432</span> <span style=color:#f92672>-</span>U pg <span style=color:#f92672>-</span>d postgres <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>è¿æ¥åˆ°æœ¬åœ°ä¸»æœºï¼ˆ</span><span style=color:#ae81ff>127.0.0.1</span><span style=color:#960050;background-color:#1e0010>ï¼‰çš„</span> PostgreSQL <span style=color:#960050;background-color:#1e0010>æ•°æ®åº“æœåŠ¡å™¨ï¼Œä½¿ç”¨ç”¨æˆ·å</span> pg <span style=color:#960050;background-color:#1e0010>è¿æ¥åˆ°åä¸º</span> postgres <span style=color:#960050;background-color:#1e0010>çš„æ•°æ®åº“</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>du <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>l <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>c{dbname} <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>åˆ‡æ¢åˆ°æ•°æ®åº“</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>dt <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>d {tablename} <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŸ¥çœ‹æŒ‡å®šè¡¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> data_directory; <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>æŸ¥çœ‹æ•°æ®ç›®å½•</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>\</span>q <span style=color:#f92672>#</span> <span style=color:#960050;background-color:#1e0010>é€€å‡ºäº¤äº’æŸ¥è¯¢æ¨¡å¼</span>
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/postgresql>postgresql</a></li><li><a href=/tags/tech>tech</a></li><li><a href=/tags/database>database</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/falasool/ rel=me title=GitHub><i data-feather=github></i></a></div><div class=footer-info>2024 Â© Falaool | Built with <a href=https://gohugo.io>Hugo</a> & Theme <a href=https://github.com/athul/archie>Archie</a> design by Athul</div></footer><script>feather.replace()</script></div></body></html>
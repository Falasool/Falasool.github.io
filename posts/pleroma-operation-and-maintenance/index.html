<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Pleroma | 维护日志(二) - Falasool</title><link rel=icon type=image/png href=static/img/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="重建实例后和小站的相处记录"><meta property="og:image" content><meta property="og:title" content="Pleroma | 维护日志(二) "><meta property="og:description" content="重建实例后和小站的相处记录"><meta property="og:type" content="article"><meta property="og:url" content="https://falasool.github.io/posts/pleroma-operation-and-maintenance/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-15T18:52:31+08:00"><meta property="article:modified_time" content="2023-05-15T18:52:31+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pleroma | 维护日志(二) "><meta name=twitter:description content="重建实例后和小站的相处记录"><script src=https://falasool.github.io/js/feather.min.js></script>
<link href=https://falasool.github.io/css/fonts.4bacf4386d3f58fdc378d205a903311c80158bf414d25698589b658e0273156d.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://falasool.github.io/css/main.42ea0af34aee3ba499cf9fa3204f9c629e4d0c0434c099da10346cf97e22e0c6.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://falasool.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://falasool.github.io/>Falasool</a></div><nav><a href=/friends/></a>
<a href=/about>About</a>
<a href=/friends>Friends</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Pleroma | 维护日志(二)</h1><div class=meta>Posted on May 15, 2023</div></div><section class=body><p>前情：postgreSQL 数据库达到了惊人的 15G，把硬盘撑爆了且抢修无果。这是炸站重来后的运维日志。<a href=https://ponder.lol/2023/pleroma-operation-and-maintenance2/>Pleroma | 维护日志(一)</a> 已记录的内容不再重复</p><h2 id=数据库相关>数据库相关</h2><ol><li>登录数据库，报错：psql: error: FATAL: Peer authentication failed for user &ldquo;postgres&rdquo;</li></ol><p>按照 <a href=https://stackoverflow.com/questions/18664074/getting-error-peer-authentication-failed-for-user-postgres-when-trying-to-ge>https://stackoverflow.com/questions/18664074/getting-error-peer-authentication-failed-for-user-postgres-when-trying-to-ge</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># 修改配置文件（改成 md5 也可以，但是 trust 能免密登录）
</span></span><span style=display:flex><span>vim /etc/postgresql/13/main/pg_hba.conf
</span></span><span style=display:flex><span><span style=color:#a6e22e>+ local   all             postgres                                trust
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span># 重启数据库
</span></span><span style=display:flex><span>service postgresql restart
</span></span></code></pre></div><ol start=2><li><a href=https://blog.debula.ml/>@debula</a> 和 <a href=https://seviche.cc/about>@Seviche</a> 帮忙提取了我的远程缓存 orz，记录一下：</li></ol><p>今天尝试了一下 ，在 JSON 中可以使用 <code>->></code> 来提取 jsonb 的 key 对应的 value，比如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>select data from activities where data-&gt;&gt;&#39;actor&#39; = &#39;https://ponderduck.cc/users/yaya&#39; order by data-&gt;&gt;&#39;published&#39;
</span></span></code></pre></div><p>可以提取用户所有的 activities，再 join 一下 objects 就得到了结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>SELECT a.&#34;actor&#34;, a.&#34;data&#34;-&gt;&gt;&#39;type&#39; AS type, a.&#34;updated_at&#34;, o.&#34;data&#34; 
</span></span><span style=display:flex><span>FROM &#34;activities&#34; AS a 
</span></span><span style=display:flex><span>INNER JOIN &#34;objects&#34; AS o
</span></span><span style=display:flex><span>ON (o.&#34;data&#34;-&gt;&gt;&#39;id&#39;) = COALESCE(a.&#34;data&#34;-&gt;&#39;object&#39;-&gt;&gt;&#39;id&#39;, a.&#34;data&#34;-&gt;&gt;&#39;object&#39;)
</span></span><span style=display:flex><span>WHERE a.&#34;data&#34;-&gt;&gt;&#39;actor&#39; = &#39;https://ponderduck.cc/users/yaya&#39;
</span></span><span style=display:flex><span>OR a.&#34;data&#34;-&gt;&#39;to&#39; ? &#39;https://ponderduck.cc/users/yaya&#39;
</span></span><span style=display:flex><span>OR a.&#34;data&#34;-&gt;&#39;cc&#39; ? &#39;https://ponderduck.cc/users/yaya&#39;
</span></span><span style=display:flex><span>ORDER BY a.&#34;updated_at&#34; LIMIT 5;
</span></span></code></pre></div><p>最后再 copy 到本地目录就好了～</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>copy(SELECT ...) to &#39;/var/lib/postgresql/yaya.csv&#39; (FORMAT &#39;csv&#39;, DELIMITER &#39;,&#39;, HEADER true, NULL &#39;UNKOWN&#39;, ENCODING &#39;UTF8&#39;);
</span></span></code></pre></div><p>我导出的包括收藏和别人的互动（回复/收藏/转发），如果只要创建的话：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>pleroma=# select count(data) from activities where data-&gt;&gt;&#39;actor&#39; = &#39;https://ponderduck.cc/users/yaya&#39; and data-&gt;&gt;&#39;type&#39; = &#39;Create&#39;;
</span></span><span style=display:flex><span> count
</span></span><span style=display:flex><span>\-------
</span></span><span style=display:flex><span>  1624
</span></span><span style=display:flex><span>(1 row)
</span></span></code></pre></div><p>也可以看这篇超棒的博客：<a href=https://blog.debula.ml/index.php/archives/5/#1.%E7%A4%BE%E4%BA%A4%E7%BD%91%E7%BB%9C%EF%BC%9APleroma>社交网络：Pleroma</a></p><ol start=3><li>定期清理数据库的 objects</li></ol><h2 id=磁盘>磁盘</h2><h3 id=自动清理-tmp-目录>自动清理 tmp 目录</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># 打开系统级别的 crontab
</span></span><span style=display:flex><span>crontab -e
</span></span><span style=display:flex><span># 在文件末尾粘贴保存以下命令（每天 00:00 删除 最近三天未使用并不属于 root 用户的文件）
</span></span><span style=display:flex><span>0 0 * * * sudo find /tmp -type f ! -user root -atime +3 -delete
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[xxx@xxx ~]# psql -U postgres
</span></span><span style=display:flex><span>psql (13.11 (Debian 13.11-0+deb11u1))
</span></span><span style=display:flex><span>Type &#34;help&#34; for help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres=# SELECT pg_size_pretty( pg_database_size(&#39;pleroma&#39;) );
</span></span><span style=display:flex><span> pg_size_pretty 
</span></span><span style=display:flex><span>----------------
</span></span><span style=display:flex><span> 576 MB
</span></span><span style=display:flex><span>(1 row)
</span></span></code></pre></div><h2 id=admin-fe>Admin-FE</h2><p>settings/Logger：把日志级别改为 <code>:warn</code></p><h2 id=参考--致谢>参考 & 致谢</h2><p><a href=https://www.myfreax.com/tmp-directory-in-linux/>Linux 临时目录 /tmp 与 /var/tmp</a></p><p><a href=https://navicat.com/en/company/aboutus/blog/673-design-select-queries-using-navicat-s-query-builder>https://navicat.com/en/company/aboutus/blog/673-design-select-queries-using-navicat-s-query-builder</a></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/pleroma>pleroma</a></li><li><a href=/tags/fediverse>fediverse</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/falasool/ rel=me title=GitHub><i data-feather=github></i></a></div><div class=footer-info>2024 © Falaool | Built with <a href=https://gohugo.io>Hugo</a> & Theme <a href=https://github.com/athul/archie>Archie</a> design by Athul</div></footer><script>feather.replace()</script></div></body></html>
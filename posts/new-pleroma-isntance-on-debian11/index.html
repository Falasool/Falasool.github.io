<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Pleroma | 在 Debian 上搭建 pleroma 实例 - Falasool</title><link rel=icon type=image/png href=static/img/favicon.png><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="建站记录"><meta property="og:image" content><meta property="og:title" content="Pleroma | 在 Debian 上搭建 pleroma 实例"><meta property="og:description" content="建站记录"><meta property="og:type" content="article"><meta property="og:url" content="https://falasool.github.io/posts/new-pleroma-isntance-on-debian11/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-03T01:29:15+08:00"><meta property="article:modified_time" content="2023-06-03T01:29:15+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Pleroma | 在 Debian 上搭建 pleroma 实例"><meta name=twitter:description content="建站记录"><script src=https://falasool.github.io/js/feather.min.js></script>
<link href=https://falasool.github.io/css/fonts.4bacf4386d3f58fdc378d205a903311c80158bf414d25698589b658e0273156d.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://falasool.github.io/css/main.42ea0af34aee3ba499cf9fa3204f9c629e4d0c0434c099da10346cf97e22e0c6.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://falasool.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"></head><body><div class=content><header><div class=main><a href=https://falasool.github.io/>Falasool</a></div><nav><a href=/friends/></a>
<a href=/about>About</a>
<a href=/friends>Friends</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Pleroma | 在 Debian 上搭建 pleroma 实例</h1><div class=meta>Posted on Jun 3, 2023</div></div><section class=body><h2 id=前置步骤>前置步骤</h2><h3 id=安装依赖>安装依赖</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 更新</span>
</span></span><span style=display:flex><span>apt-get update
</span></span><span style=display:flex><span><span style=color:#75715e># 安装依赖</span>
</span></span><span style=display:flex><span>apt install unzip libncurses5 postgresql postgresql-contrib nginx snapd libmagic-dev
</span></span><span style=display:flex><span>apt install imagemagick ffmpeg libimage-exiftool-perl
</span></span></code></pre></div><h3 id=postgresql-性能调优><del>PostgreSQL 性能调优</del></h3><p><del>根据 pgTune 修改配置文件</del></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vim /etc/postgresql/13/main/postgresql.conf
</span></span></code></pre></div><p>重启 PostgreSQL</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl restart postgresql
</span></span></code></pre></div><h2 id=安装-pleroma>安装 Pleroma</h2><ol><li>创建 Pleroma 用户</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>adduser --system --shell /bin/false --home /opt/pleroma pleroma
</span></span></code></pre></div><p>创建 pleroma 用户，指定家目录为 <code>/opt/pleroma</code>，用于配置 pleroma 的环境和文件，并禁止登录</p><ol start=2><li>检测系统架构与 libc 版本，并根据结果设置环境变量 FLAVOUR</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>arch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>;<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$arch<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span> arch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;amd64&#34;</span>;<span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$arch<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;armv7l&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span> arch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;arm&#34;</span>;<span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$arch<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aarch64&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span> arch<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;arm64&#34;</span>;<span style=color:#66d9ef>else</span> echo <span style=color:#e6db74>&#34;Unsupported arch: </span>$arch<span style=color:#e6db74>&#34;</span>&gt;&amp;2;<span style=color:#66d9ef>fi</span>;<span style=color:#66d9ef>if</span> getconf GNU_LIBC_VERSION&gt;/dev/null;<span style=color:#66d9ef>then</span> libc_postfix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>;<span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>ldd 2&gt;&amp;1|head -c 9<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;musl libc&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span> libc_postfix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-musl&#34;</span>;<span style=color:#66d9ef>elif</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>find /lib/libc.musl*|wc -l<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span> libc_postfix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-musl&#34;</span>;<span style=color:#66d9ef>else</span> echo <span style=color:#e6db74>&#34;Unsupported libc&#34;</span>&gt;&amp;2;<span style=color:#66d9ef>fi</span>;echo <span style=color:#e6db74>&#34;</span>$arch$libc_postfix<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 输出</span>
</span></span><span style=display:flex><span>amd64
</span></span></code></pre></div><p>所以设置环境变量为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export FLAVOUR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;amd64&#34;</span>
</span></span></code></pre></div><ol start=3><li>下载 pleroma 文件到 /tmp 目录并解压</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>su pleroma -s $SHELL -lc <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>curl &#39;https://git.pleroma.social/api/v4/projects/2/jobs/artifacts/stable/download?job=</span>$FLAVOUR<span style=color:#e6db74>&#39; -o /tmp/pleroma.zip
</span></span></span><span style=display:flex><span><span style=color:#e6db74>unzip /tmp/pleroma.zip -d /tmp/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><ol start=4><li>移动文件到 /opt/pleroma 并删除 /tmp</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>su pleroma -s $SHELL -lc <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mv /tmp/release/* /opt/pleroma
</span></span></span><span style=display:flex><span><span style=color:#e6db74>rmdir /tmp/release
</span></span></span><span style=display:flex><span><span style=color:#e6db74>rm /tmp/pleroma.zip
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><ol start=5><li>创建各种目录及赋权操作 uploads 目录并赋权</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># uploads 目录 &amp; 赋权</span>
</span></span><span style=display:flex><span>mkdir -p /var/lib/pleroma/uploads
</span></span><span style=display:flex><span>chown -R pleroma /var/lib/pleroma
</span></span><span style=display:flex><span><span style=color:#75715e># static 目录 &amp; 设置所有者为 pleroma</span>
</span></span><span style=display:flex><span>mkdir -p /var/lib/pleroma/static
</span></span><span style=display:flex><span>chown -R pleroma /var/lib/pleroma
</span></span><span style=display:flex><span><span style=color:#75715e># 配置文件目录 &amp; 设置所有者为 pleroma</span>
</span></span><span style=display:flex><span>mkdir -p /etc/pleroma
</span></span><span style=display:flex><span>chown -R pleroma /etc/pleroma
</span></span></code></pre></div><ol start=6><li>生成配置文件</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>su pleroma -s $SHELL -lc <span style=color:#e6db74>&#34;./bin/pleroma_ctl instance gen --output /etc/pleroma/config.exs --output-psql /tmp/setup_db.psql&#34;</span>
</span></span></code></pre></div><p>回答若干问题</p><ol start=7><li>创建 postgres 数据库</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> su postgres -s $SHELL -lc <span style=color:#e6db74>&#34;psql -f /tmp/setup_db.psql&#34;</span>
</span></span></code></pre></div><ol start=8><li>更新数据库 schema</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>su pleroma -s $SHELL -lc <span style=color:#e6db74>&#34;./bin/pleroma_ctl migrate&#34;</span>
</span></span></code></pre></div><ol start=9><li>启动实例</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>su pleroma -s $SHELL -lc &#34;./bin/pleroma daemon&#34;
</span></span></code></pre></div><ol start=10><li>等待一会检测实例运行情况</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl http://localhost:4000/api/v1/instance
</span></span></code></pre></div><ol start=10><li>暂停实例运行</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>su pleroma -s $SHELL -lc &#34;./bin/pleroma stop&#34;
</span></span></code></pre></div><h2 id=通配符-ssl-证书自动续期>通配符 SSL 证书自动续期</h2><p>如果预装了certbot要先删掉 <code>apt-get remove certbot</code></p><p>安装 certbot</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>snap install core
</span></span><span style=display:flex><span>snap refresh core
</span></span><span style=display:flex><span>snap install --classic certbot
</span></span><span style=display:flex><span>ln -s /snap/bin/certbot /usr/bin/certbot
</span></span><span style=display:flex><span>snap set certbot trust-plugin-with-root<span style=color:#f92672>=</span>ok
</span></span><span style=display:flex><span>snap install certbot-dns-cloudflare
</span></span></code></pre></div><p>放置凭据</p><p>Token 在 <a href=https://dash.cloudflare.com/profile/api-tokens>https://dash.cloudflare.com/profile/api-tokens</a> 生成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo mkdir -p /root/.secrets/
</span></span><span style=display:flex><span>sudo touch /root/.secrets/cloudflare.ini
</span></span><span style=display:flex><span><span style=color:#75715e># 添加/.secrets目录与cloudflare.ini文件</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>0700</span> /root/.secrets/
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>0400</span> /root/.secrets/cloudflare.ini
</span></span><span style=display:flex><span><span style=color:#75715e># 指定权限</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vim /root/.secrets/cloudflare.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Cloudflare API token used by Certbot</span>
</span></span><span style=display:flex><span>dns_cloudflare_api_token <span style=color:#f92672>=</span> 0123456789abcdef0123456789abcdef01234567
</span></span></code></pre></div><p>申请证书</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>certbot certonly <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --dns-cloudflare <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --dns-cloudflare-credentials ~/.secrets/cloudflare.ini <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -d example.com
</span></span><span style=display:flex><span>  -d *.example.com
</span></span></code></pre></div><p>测试自动延期</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>certbot renew --dry-run
</span></span></code></pre></div><h2 id=nginx>Nginx</h2><p>复制 Pleroma 的 nginx 配置到 nginx 目录</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cp /opt/pleroma/installation/pleroma.nginx /etc/nginx/sites-available/pleroma.conf
</span></span><span style=display:flex><span>ln -s /etc/nginx/sites-available/pleroma.conf /etc/nginx/sites-enabled/pleroma.conf
</span></span></code></pre></div><p>编辑 Pleroma 的 nginx 配置文件，改成自己的域名</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vim /etc/nginx/sites-available/pleroma.conf
</span></span></code></pre></div><p>这里改成</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>         <span style=color:#ae81ff>301</span> https://&lt;domain&gt;$request_uri;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>重启 nginx</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nginx -t
</span></span><span style=display:flex><span>systemctl start nginx
</span></span><span style=display:flex><span><span style=color:#75715e># or</span>
</span></span><span style=display:flex><span>nginx -s reload
</span></span></code></pre></div><h2 id=设置系统服务>设置系统服务</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cp /opt/pleroma/installation/pleroma.service /etc/systemd/system/pleroma.service
</span></span><span style=display:flex><span>systemctl start pleroma
</span></span><span style=display:flex><span>systemctl enable pleroma
</span></span></code></pre></div><p>可以访问啦</p><h2 id=创建管理员账户>创建管理员账户</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-perl data-lang=perl><span style=display:flex><span>cd <span style=color:#e6db74>/opt/</span>pleroma<span style=color:#f92672>/</span>bin
</span></span><span style=display:flex><span>su pleroma <span style=color:#f92672>-</span>s $SHELL <span style=color:#f92672>-</span>lc <span style=color:#e6db74>&#34;./bin/pleroma_ctl user new &lt;joeuser&gt; &lt;joeuser@sld.tld&gt; --admin&#34;</span>
</span></span></code></pre></div><h2 id=参考--致谢>参考 & 致谢</h2><p><a href=https://suicablog.cobaltkiss.blue/posts/pleroma-installation-on-linux-using-otp-releases/>在 Debian 10 / Ubuntu 20.04 上安装 Pleroma</a></p><p><a href=https://suicablog.cobaltkiss.blue/posts/wildcard-with-cloudflare-using-certbot/>通配符域名证书申请与自动续费（Nginx，Debian 10）</a></p><p><a href=https://lily-is.land/infra/pleroma/-/blob/servant/docs/configuration/cheatsheet.md>Configuration Cheat Sheet</a></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/pleroma>pleroma</a></li><li><a href=/tags/fediverse>fediverse</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/falasool/ rel=me title=GitHub><i data-feather=github></i></a></div><div class=footer-info>2024 © Falaool | Built with <a href=https://gohugo.io>Hugo</a> & Theme <a href=https://github.com/athul/archie>Archie</a> design by Athul</div></footer><script>feather.replace()</script></div></body></html>
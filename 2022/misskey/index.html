<!doctype html><html lang dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><title>Misskey</title><link rel=canonical href=https://falasool.github.io/2022/misskey/><link rel=stylesheet href=/scss/style.min.404c857d6b39ded4a65e25cd388b671a161b5fde50710c44b10fa37553ef0a5d.css><meta property="og:title" content="Misskey"><meta property="og:description" content><meta property="og:url" content="https://falasool.github.io/2022/misskey/"><meta property="og:site_name" content="Rubber Duck's Bizarre Adventure"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="tutorial"><meta property="article:tag" content="miskey"><meta property="article:published_time" content="2022-11-19T20:19:15+08:00"><meta property="article:modified_time" content="2022-11-19T20:19:15+08:00"><meta name=twitter:title content="Misskey"><meta name=twitter:description content><link rel="shortcut icon" href=/img/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-SSG1Q6LM3K"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SSG1Q6LM3K",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu268ba2ccfeb36e3648936a87aa48bcbd_263179_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🦷</span></figure><div class=site-meta><h1 class=site-name><a href=/>Rubber Duck's Bizarre Adventure</a></h1><h2 class=site-description>人間讃歌は「勇気」の讃歌ッ！！人間のすばらしさは勇気のすばらしさ！！</h2></div></header><ol class=social-menu><li><a href=https://github.com/Falasool/ target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-paw" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.7 13.5c-1.1-2-1.441-2.5-2.7-2.5-1.259.0-1.736.755-2.836 2.747-.942 1.703-2.846 1.845-3.321 3.291-.097.265-.145.677-.143.962.0 1.176.787 2 1.8 2 1.259.0 3-1 4.5-1s3.241 1 4.5 1c1.013.0 1.8-.823 1.8-2 0-.285-.049-.697-.146-.962-.475-1.451-2.512-1.835-3.454-3.538z"/><path d="M20.188 8.082A1.039 1.039.0 0019.782 8h-.015c-.735.012-1.56.75-1.993 1.866-.519 1.335-.28 2.7.538 3.052.129.055.267.082.406.082.739.0 1.575-.742 2.011-1.866.516-1.335.273-2.7-.54-3.052z"/><path d="M9.474 9c.055.0.109.0.163-.011.944-.128 1.533-1.346 1.32-2.722C10.754 4.97 9.91 4 9.025 4c-.055.0-.109.0-.163.011-.944.128-1.533 1.346-1.32 2.722C7.746 8.026 8.59 9 9.475 9z"/><path d="M16.456 6.733c.214-1.376-.375-2.594-1.32-2.722A1.164 1.164.0 0014.974 4c-.885.0-1.728.97-1.93 2.267-.214 1.376.375 2.594 1.32 2.722.054.007.108.011.162.011.885.0 1.73-.974 1.93-2.267z"/><path d="M5.69 12.918c.816-.352 1.054-1.719.536-3.052C5.79 8.742 4.955 8 4.217 8c-.14.0-.277.027-.407.082-.816.352-1.054 1.719-.536 3.052C3.71 12.258 4.545 13 5.283 13c.14.0.277-.027.407-.082z"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/projects/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-app-window" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 5m0 2a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M6 8h.01"/><path d="M9 8h.01"/></svg><span>Projects</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/friends/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Friends</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://falasool.github.io/ selected>English</option><option value=https://falasool.github.io/zh-cn/>中文</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/misskey/>Misskey</a>
<a href=/categories/fediverse/>Fediverse</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/2022/misskey/>Misskey</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 19, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><p>本次搭建使用 Ubuntu 22.10 系统</p><p>超级啰嗦预警</p><h2 id=购买-vps>购买 VPS</h2><p>⚠️不要买机房在大陆的服务商 VPS ⚠️</p><p>在备案通过之前 80 和 443 端口是封禁的 -> 无法申请 SSL 证书 -> Misskey 需要 SSL 才能访问，GG</p><p>（即使没有这个问题，买大陆节点的服务建站也是一种自杀行为）</p><h3 id=注册>注册</h3><p>注册Vultr 账号，充值</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey1.png loading=lazy alt=image-20221120012614543></p><h3 id=创建-vps>创建 VPS</h3><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/image-20221120012203832.png loading=lazy alt=image-20221120012203832></p><ul><li><p>选 Cloud Computer</p></li><li><p>CPU 选 AMD 和 Intel 都行</p></li><li><p>机房位置选择日本、新加坡、美西都行，一般不推荐欧洲（对于中国国内）</p></li><li><p>选择操作系统：Ubuntu 22.10 x64</p></li><li><p>选择 Size：$5 的 1C1G1TB 套餐（记得勾选 No Thanks）</p></li><li><p>关闭自动备份，省 $1</p></li><li><p>Additional Features：勾选 Enable IPv6</p></li><li><p>添加 SSH Keys</p></li></ul><p>打开命令行，输入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh-keygen -t rsa -b <span class=m>4096</span> -C <span class=s2>&#34;Example comment&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>在这行提示后面输入你想要保存密钥的路径</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Generating public/private rsa key pair.
</span></span><span class=line><span class=cl>Enter file in which to save the key (/home/example_user/.ssh/id_rsa):
</span></span></code></pre></td></tr></table></div></div><p>我输入（uu是我的电脑用户名）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/home/uu/.ssh/id_rsa_vultr
</span></span></code></pre></td></tr></table></div></div><p>所以在 <code>/.ssh</code> 目录下可以找到 <code>id_rsa_vultr</code> 和 <code>id_rsa_vultr.pub</code> 文件，它们分别是私钥和公钥</p><p>接下来要把公钥内容添加到 vultr 去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 进入.ssh 目录</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> .ssh
</span></span><span class=line><span class=cl><span class=c1># 打印文件内容</span>
</span></span><span class=line><span class=cl>cat id_rsa_vultr.pub
</span></span></code></pre></td></tr></table></div></div><ul><li>这时底部付款栏应该显示 <code>$5.00/month</code> ，点击 <code>Deploy Now</code> 确认创建服务器，等待一会，等 Status 变成 Running 就好了</li></ul><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey2-1.png loading=lazy alt=image-20221120012909994></p><p>点击刚刚创建的 VPS，看到如下界面。</p><p>左下角的 IP Address、Username、Password 是待会连接服务器的时候，要用到的 SSH 连接信息</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey3.png loading=lazy alt=image-20221120013010174></p><ol><li>登录 VNC：查看控制台</li><li>关机：就和关电脑一样（关机的时候仍然在计费哦！）</li><li>重启：就和重启电脑一样</li><li>重装系统：把服务器重置成刚创建时的状态</li><li>销毁/删除：销毁了服务器就不计费了，数据丢失，无法找回</li></ol><p>Snapshots：快照，指将当前 VPS 的状态保存下来，对 VPS 进行完整备份</p><p>服务器创建完成</p><h3 id=检查-ip>检查 IP</h3><p>Ping 一下 IP</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey4.png loading=lazy alt=image-20221120013147886></p><p>用检查工具比如 <a class=link href=https://ip112.cn/ target=_blank rel=noopener>https://ip112.cn/</a> 检查 IP，此 IP 可用</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey5.png loading=lazy alt=image-20221120013305544></p><p>其它测试工具</p><ul><li><a class=link href=http://ping.pe/ target=_blank rel=noopener>http://ping.pe/</a> — 全球节点 Ping，包括中国的三大运营商</li><li><a class=link href=http://ping.chinaz.com/ target=_blank rel=noopener>http://ping.chinaz.com/</a> — Ping 检测中国大陆的访问情况</li></ul><h2 id=域名>域名</h2><p>在域名商 <a class=link href=https://www.dynadot.com/zh/ target=_blank rel=noopener>Dynadot</a> 注册账号，买一个域名</p><h3 id=解析域名>解析域名</h3><p>依次点击</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey6.png loading=lazy alt=image-20221120013439245></p><p>暂停⏸️</p><p>去 <a class=link href=https://dash.cloudflare.com/ target=_blank rel=noopener>CloudFlare</a> 注册登录账号，依次操作：</p><p>添加新站点</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey7.png loading=lazy alt=image-20221120013614146></p><p>输入你的域名</p><p><img src=https://raw.githubusercontent.com/Falasool/blog-pic-bed/main/blog/misskey8.png loading=lazy alt=image-20221120013635155></p><p>选择免费方案</p><p>添加 DNS 解析记录</p><ul><li><p><code>*</code> 是通配符，意思是我的二级域名，xxx.ponderduck.cc 的 DNS 解析也一起被接管了。不用我一个一个设置</p></li><li><p>第二行是域名本体</p></li><li><p><code>www</code> 让输入 <a class=link href=https://www.ponderduck.cc target=_blank rel=noopener>www.ponderduck.cc</a> 也能访问</p></li></ul><p>复制 CloudFlare 提供的两个名称服务器，填进 Dynadot 的 DNS 设置，保存</p><p>回到 CloudFlare 点击 <code>Done, check nameservers</code>，等一会</p><p><del>测试，ping 你的域名，返回服务器 IP 说明解析生效</del></p><p>开启完全 SSL，否则访问站点会报「重定向次数过多」的错误</p><p><img src=/Library/Application%20Support/typora-user-images/image-20221121185003309.png loading=lazy alt=image-20221121185003309></p><p>✅域名解析完成</p><h2 id=服务器基础配置>服务器基础配置</h2><p><strong>对哪一步不自信，可以在开始做之前先去服务器管理面板创建一个快照（snapshots），快照就是存档点</strong></p><h3 id=远程连接>远程连接</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh root@101.113.22.42 <span class=c1># 换成你的ip地址，回车</span>
</span></span></code></pre></td></tr></table></div></div><p>然后把密码从 vultr 复制过来回车，会看到类似这样的提示就表示连接服务器成功</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Welcome to Ubuntu 22.10 <span class=o>(</span>GNU/Linux 5.19.0-23-generic x86_64<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> * Documentation:  https://help.ubuntu.com
</span></span><span class=line><span class=cl> * Management:     https://landscape.canonical.com
</span></span><span class=line><span class=cl> * Support:        https://ubuntu.com/advantage
</span></span><span class=line><span class=cl> ...省略一部分内容...
</span></span><span class=line><span class=cl>root@vultr:~# 
</span></span></code></pre></td></tr></table></div></div><h3 id=安全设置>安全设置</h3><p>因为 root 权限太太太强大，为了避免婴儿（我）拿核武器发射按钮的情况出现，创建一个普通用户日常使用</p><h4 id=新建普通用户并设定密码>新建普通用户并设定密码</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>adduser vpsadmin <span class=c1># vpsadmin是用户名</span>
</span></span></code></pre></td></tr></table></div></div><p>然后输入密码 - 确认密码（太简单会被拒绝==）</p><h4 id=赋予-vpsadmin-使用-sudo-指令的权限>赋予 「vpsadmin」 使用 sudo 指令的权限</h4><p>什么是 su 和 sudo 请看：<a class=link href=https://blog.gtwang.org/linux/sudo-su-command-tutorial-examples/ target=_blank rel=noopener>Linux 的 su 與 sudo 指令教學與範例</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo adduser vpsadmin sudo
</span></span></code></pre></td></tr></table></div></div><p>另外开一个终端窗口，登录 vpsadmin 账号</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh vpsadmin@185.202.62.49 <span class=c1># 换成你的IP，回车，然后输入密码</span>
</span></span></code></pre></td></tr></table></div></div><p>验证是否获得 sudo 权限</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ls -al /root
</span></span></code></pre></td></tr></table></div></div><p>返回类似内容（展示 <code>/root</code> 目录下的资料）就表示成功了</p><h4 id=可选ssh免密登录>[可选]SSH免密登录</h4><p>每次登录 vpsadmin 都要手动输密码很麻烦，设置一下免密登录</p><p>在 Tabby 设置 - Profiles & connections - <code>+ New profile</code> - SSH connection</p><h4 id=禁止-root-登录>禁止 root 登录</h4><p>（禁用核按钮）</p><p>登录 root 账户，输入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano /etc/ssh/sshd_config
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>control + W</code> 进入搜索模式，输入 <code>PerimitRootLogin</code> 并回车，找到所在行，改成（记得要取掉注释 <code>#</code>！！）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PermitRootLogin: no
</span></span></code></pre></td></tr></table></div></div><p>*prohibit-password/without-password 意为禁止密码登录</p><p>使用 <code>control + O</code>，保存更改，<code>control + X</code> 退出</p><p>重新启动 SSH 服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo /etc/init.d/ssh restart
</span></span></code></pre></td></tr></table></div></div><p><strong>打开一个新窗口</strong>，尝试用 root 登录，返回 Permission denied&mldr;</p><p>✅成功禁止 root 登录</p><p>从现在开始，用「vpsadmin」这个账户远程连接 VPS 吧</p><h3 id=搭建环境>搭建环境</h3><h4 id=修改服务器时间>修改服务器时间</h4><p>查看时间</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>timedatectl
</span></span></code></pre></td></tr></table></div></div><p>列出所有时区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>timedatectl list-timezones
</span></span></code></pre></td></tr></table></div></div><p>改成香港🇭🇰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo timedatectl set-timezone Asia/Hong_Kong
</span></span></code></pre></td></tr></table></div></div><h4 id=安装常用命令>安装常用命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get install curl wget screen tree -y
</span></span></code></pre></td></tr></table></div></div><p>*curl用于请求 Web 服务器</p><p>*wget用来下载软件包</p><p>*screen用于命令行终端的窗口切换</p><p>*tree用于显示当前文件夹的目录结构</p><p>（如果你有其它要用的也一起加进来，或者要用了再用这个命令单独安装也可以）</p><h4 id=添加-swap>添加 SWAP</h4><p>swap 是 Linux 中的虚拟内存，用于在物理内存不足的情况下储存临时数据，可以提升小内存 VPS 的运行效率</p><p>确认是否已存在 SWAP</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>free -m
</span></span></code></pre></td></tr></table></div></div><p>有 Swap 项而且 total 列不为零，说明 Swap 已存在，可以自行修改分区容量，参考：为 <a class=link href=https://www.vvave.net/archives/add-swap-and-repartition-swap-for-linux.html target=_blank rel=noopener>Linux 添加 swap 分区或修改 swap 分区容量</a></p><h4 id=配置防火墙>配置防火墙</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw allow OpenSSH
</span></span><span class=line><span class=cl>sudo ufw <span class=nb>enable</span>
</span></span></code></pre></td></tr></table></div></div><p>打开防火墙</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw allow http
</span></span><span class=line><span class=cl>sudo ufw allow https
</span></span></code></pre></td></tr></table></div></div><p>打开 80、443 的端口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw allow 80/tcp
</span></span><span class=line><span class=cl>sudo ufw allow 443/tcp
</span></span></code></pre></td></tr></table></div></div><p>（其它服务需要的端口也用 <code>sudo ufw allow xx/tcp</code> 开启）</p><p>验证防火墙是否打开，端口是否开启</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw status
</span></span></code></pre></td></tr></table></div></div><p>和其它服务商不同，Vultr 没有默认防火墙设置，所以要自己开启</p><p>在 Vultr 添加防火墙规则</p><h4 id=安装-docker-和-docker-compose>安装 Docker 和 Docker Compose</h4><p>*Compose 是 Docker 的一个命令行工具，通过 yml 文件定义、创建、管理多容器的 Docker 应用</p><p>跟着 <a class=link href=https://www.51cto.com/article/715086.html target=_blank rel=noopener>如何在 Ubuntu 22.04 LTS 中安装 Docker 和 Docker Compose</a> 丝滑完成安装</p><p>推荐：<a class=link href=https://ostechnix.com/getting-started-with-docker/ target=_blank rel=noopener>Docker Commands Tutorial | Getting Started With Docker In Linux</a></p><h5 id=修改-docker-配置>修改 Docker 配置</h5><p>Docker 的配置文件路径是 <code>/etc/docker/daemon.json</code>，需要手动创建：</p><p>进入 <code>/etc/docker</code> 目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /etc/docker
</span></span></code></pre></td></tr></table></div></div><p>用 vim 编辑 <code>daemon.json</code> 文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim daemon.json
</span></span></code></pre></td></tr></table></div></div><p>进入 vim 后输入如下内容，这段代码会增加一段自定义内网 IPv6 地址，开启容器的 IPv6 功能，限制日志文件的大小（20M），限制日志文件数量，防止 Docker 日志过多占用硬盘</p><p>（代码来自<a class=link href=https://u.sb/debian-install-docker/ target=_blank rel=noopener>烧饼博客</a>）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;log-driver&#34;</span><span class=p>:</span> <span class=s2>&#34;json-file&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;log-opts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;max-size&#34;</span><span class=p>:</span> <span class=s2>&#34;20m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;max-file&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ipv6&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;fixed-cidr-v6&#34;</span><span class=p>:</span> <span class=s2>&#34;fd00:dead:beef:c0::/80&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;experimental&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ip6tables&#34;</span><span class=p>:</span><span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>⚠️ vim 和普通键入略有不用</p><ul><li><p>首先 <code>I</code> 进入编辑模式，输入内容（注意格式：大括号 <code>{}</code> 里的内容除了最后一行，都必须用英文逗号 <code>,</code> 结尾）</p></li><li><p>完成输入后，按 <code>esc</code> 回到一般模式</p></li><li><p>输入 <code>:wq</code> ，回车（意为保存-离开）</p></li><li><p>不放心可以再次进入 daemon.json 检查是否成功写入，效果类似：</p></li></ul><p>了解：<a class=link href=https://www.runoob.com/linux/linux-vim.html target=_blank rel=noopener>Linux vi/vim 是什么，怎么使用</a></p><p>重启 Docker 服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>sudo systemctl restart docker
</span></span></code></pre></td></tr></table></div></div><h5 id=检查-docker-是否正在运行>检查 Docker 是否正在运行</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status docker
</span></span></code></pre></td></tr></table></div></div><p>换个方式，再测试一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo docker run hello-world
</span></span></code></pre></td></tr></table></div></div><p>终于成功了 😭</p><h2 id=misskey>Misskey</h2><h3 id=创建安装目录>创建安装目录</h3><p>之前给 Docker 的数据和配置文件新建一个目录 <code>docker_data</code>，这个文件夹就是包住整个 Misskey 的盒子</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir -p data/docker_data
</span></span></code></pre></td></tr></table></div></div><p>进入目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> data/docker_data
</span></span></code></pre></td></tr></table></div></div><p>创建 misskey 文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir misskey
</span></span></code></pre></td></tr></table></div></div><h3 id=配置安装文件>配置安装文件</h3><p>进入 misskey 文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> misskey
</span></span></code></pre></td></tr></table></div></div><p>创建并编辑 yml 文件，让它去部署</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim docker-compose.yml
</span></span></code></pre></td></tr></table></div></div><p>按 <code>I</code>，切换到编辑模式，把以下内容粘贴进去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># Misskey minimal deploy config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w> </span><span class=c># always意味着自动重启，请注意如果您对您的配置没有信心，请不要开启这个选项，以避免进程崩溃反复重启耗费大量资源！</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>misskey/misskey:latest</span><span class=w> </span><span class=c># 这里使用了官方镜像，以避免本地构建时资源不足的问题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>misskey_web</span><span class=w> </span><span class=c># 容器名，方便管理，您可以自行修改为您觉得合适的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3001:3001&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>internal_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>external_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./config:/misskey/.config:ro</span><span class=w> </span><span class=c># 用于映射配置文件，请根据您的实际配置来决定文件夹名称，设定为只读即可；</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./files:/misskey/files</span><span class=w> </span><span class=c># 用户上传到本地的文件，如果您一开始就接入外部存储（如wasabi或是AWS S3）您可以忽略这块配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>misskey_redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>internal_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./redis:/data</span><span class=w> </span><span class=c># redis数据库的数据文件夹映射，创建后默认在 ./redis 文件夹中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:12.2-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>misskey_db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>internal_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./config/docker.env</span><span class=w> </span><span class=c># 需要使用配置文件中设置的 Docker 环境变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./db:/var/lib/postgresql/data</span><span class=w> </span><span class=c># 主数据库的数据文件夹映射，创建后默认在 ./db 文件夹中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>internal_network</span><span class=p>:</span><span class=w> </span><span class=c># 内部网络</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>external_network</span><span class=p>:</span><span class=w> </span><span class=c># 外部网</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>按 <code>esc</code> ，按 <code>:wq</code> ，回车（保存-退出）</p><p>创建 <code>config/default.yml</code> 目录并进入 yml 文件中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir config
</span></span><span class=line><span class=cl><span class=nb>cd</span> config
</span></span><span class=line><span class=cl>sudo vim default.yml
</span></span></code></pre></td></tr></table></div></div><p>按 <code>I</code>，切换到编辑模式，填入以下内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c>#━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Misskey configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌─────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ URL └─────────────────────────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Final accessible URL seen by a user.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ponderduck.cc/      </span><span class=w> </span><span class=c># 注意改成自己最后反向代理想要的网址</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ONCE YOU HAVE STARTED THE INSTANCE, DO NOT CHANGE THE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># URL SETTINGS AFTER THAT!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌───────────────────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ Port and TLS settings └───────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Misskey requires a reverse proxy to support HTTPS connections.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#                 +----- https://example.tld/ ------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   +------+      |+-------------+      +----------------+|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   | User | ---&gt; || Proxy (443) | ---&gt; | Misskey (3000) ||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   +------+      |+-------------+      +----------------+|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#                 +---------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   You need to set up a reverse proxy. (e.g. nginx)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   An encrypted connection with HTTPS is highly recommended</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   because tokens may be transferred in GET requests.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># The port that your Misskey server should listen on.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌──────────────────────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ PostgreSQL configuration └────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5432</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Database name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>db</span><span class=p>:</span><span class=w> </span><span class=l>misskey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>example-misskey-user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pass</span><span class=p>:</span><span class=w> </span><span class=l>example-misskey-pass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Whether disable Caching queries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#disableCache: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Extra Connection options</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#extra:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  ssl: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌─────────────────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ Redis configuration └─────────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#family: 0  # 0=Both, 4=IPv4, 6=IPv6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#pass: example-pass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#prefix: example-prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#db: 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌─────────────────────────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ Elasticsearch configuration └─────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#elasticsearch:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  host: localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  port: 9200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  ssl: false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  user: </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  pass: </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌───────────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ ID generation └───────────────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># You can select the ID generation method.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># You don&#39;t usually need to change this setting, but you can</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># change it according to your preferences.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Available methods:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># aid ... Short, Millisecond accuracy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># meid ... Similar to ObjectID, Millisecond accuracy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ulid ... Millisecond accuracy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># objectid ... This is left for backward compatibility</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ONCE YOU HAVE STARTED THE INSTANCE, DO NOT CHANGE THE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ID SETTINGS AFTER THAT!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;aid&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ┌─────────────────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#───┘ Other configuration └─────────────────────────────────────</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Whether disable HSTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#disableHsts: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Number of worker processes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#clusterLimit: 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Job concurrency per worker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># deliverJobConcurrency: 128</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># inboxJobConcurrency: 16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Job rate limiter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># deliverJobPerSec: 128</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># inboxJobPerSec: 16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Job attempts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># deliverJobMaxAttempts: 12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># inboxJobMaxAttempts: 8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># IP address family used for outgoing request (ipv4, ipv6 or dual)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#outgoingAddressFamily: ipv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Syslog option</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#syslog:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  host: localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  port: 514</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Proxy for HTTP/HTTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#proxy: http://127.0.0.1:3128</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#proxyBypassHosts: [</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  &#39;example.com&#39;,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  &#39;192.0.2.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Proxy for SMTP/SMTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#proxySmtp: http://127.0.0.1:3128   # use HTTP/1.1 CONNECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#proxySmtp: socks4://127.0.0.1:1080 # use SOCKS4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#proxySmtp: socks5://127.0.0.1:1080 # use SOCKS5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Media Proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#mediaProxy: https://example.com/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Proxy remote files (default: false)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#proxyRemoteFiles: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Sign to ActivityPub GET request (default: false)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#signToActivityPubGet: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#allowedPrivateNetworks: [</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  &#39;127.0.0.1/32&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Upload or download file size limits (bytes)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#maxFileSize: 262144000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>按 <code>esc</code> ，按 <code>:wq</code> ，回车（保存-退出）</p><p>进入 env 文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim docker.env
</span></span></code></pre></td></tr></table></div></div><p>按 <code>I</code>，切换到编辑模式，填写如下内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># db settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>POSTGRES_PASSWORD=example-misskey-pass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>POSTGRES_USER=example-misskey-user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>POSTGRES_DB=misskey</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=部署>部署</h3><p>还记得我说「创建并编辑 yml 文件，让它去部署」吗？</p><p>现在文件已经配置完毕了，是时候让它跑起来了！</p><p>双手合十🙏</p><p>切换到上一级目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ..
</span></span></code></pre></td></tr></table></div></div><p>初始化数据库</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo docker-compose run --rm web yarn run init 
</span></span></code></pre></td></tr></table></div></div><p>后台启动项目容器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo docker-compose up -d 
</span></span></code></pre></td></tr></table></div></div><h3 id=访问站点>访问站点</h3><p>查看端口状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo lsof -i:&lt;port&gt;
</span></span></code></pre></td></tr></table></div></div><p>假如这个端口不能用，那就换一个。</p><p>新端口要在服务商防火墙、ufw 命令、<code>default.yml</code> 和 <code>docker-compose.yml</code> 里都开启、改过来</p><p>然后重启 Docker</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo docker-compose restart <span class=o>[</span>指定服务的容器<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>完成这一步之后，尝试用 IP 访问站点吧</p><p>在浏览器输入 <code>http://&lt;ip>:&lt;port></code>（IP 可以用 <code>curl ip.sb</code> 返回）</p><p>（；</p><p>还有两个任务</p><ul><li>SSL 证书</li><li>反向代理</li></ul><h3 id=nginx>Nginx</h3><h4 id=安装-nginx>安装 Nginx</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install nginx
</span></span></code></pre></td></tr></table></div></div><p>调整防火墙，允许 Nginx 服务通过</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw allow <span class=s1>&#39;Nginx HTTP&#39;</span>
</span></span><span class=line><span class=cl>sudo ufw allow <span class=s1>&#39;Nginx HTTPS&#39;</span>
</span></span><span class=line><span class=cl>sudo ufw allow <span class=s1>&#39;Nginx FULL&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>查看更改结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ufw status
</span></span></code></pre></td></tr></table></div></div><p>查看 Nginx 状态（是 active 就行）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl status nginx
</span></span></code></pre></td></tr></table></div></div><p>在浏览器输入 http://your_vps_ip，返回 Nginx 默认页面</p><p>让 Nginx 在系统启动时自动启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> nginx
</span></span></code></pre></td></tr></table></div></div><h4 id=设置服务器块>设置服务器块</h4><p>创建站点对应目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo mkdir -p /var/www/ponderduck.cc/html
</span></span></code></pre></td></tr></table></div></div><p>使用<code>$USER</code>环境变量分配目录的所有权</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo chown -R $USER:$USER /var/www/ponderduck.cc/html
</span></span></code></pre></td></tr></table></div></div><p>如果我们没有修改自己的<code>umask</code>值，那么 Web 根目录的权限应该正确，我们可以通过输入以下命令来确认：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod -R <span class=m>755</span> /var/www/ponderduck.cc
</span></span></code></pre></td></tr></table></div></div><p>编辑<code>index.html</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /var/www/ponderduck.cc/html/index.html
</span></span></code></pre></td></tr></table></div></div><p>添加以下示例HTML</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Welcome to ponderduck.cc!<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Success!  The ponderduck.cc server block is working!<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>为 Nginx 创建一个服务器块</p><p>创建一个新文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /etc/nginx/sites-available/ponderduck.conf
</span></span></code></pre></td></tr></table></div></div><p>添加以下内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>server <span class=o>{</span>
</span></span><span class=line><span class=cl>        listen 80<span class=p>;</span>
</span></span><span class=line><span class=cl>        listen <span class=o>[</span>::<span class=o>]</span>:80<span class=p>;</span>
</span></span><span class=line><span class=cl>        root /var/www/ponderduck.cc/html<span class=p>;</span>
</span></span><span class=line><span class=cl>        index index.html index.htm index.nginx-debian.html<span class=p>;</span>
</span></span><span class=line><span class=cl>        server_name ponderduck.cc www.ponderduck.cc<span class=p>;</span>
</span></span><span class=line><span class=cl>        location / <span class=o>{</span>
</span></span><span class=line><span class=cl>                try_files <span class=nv>$uri</span> <span class=nv>$uri</span>/ <span class=o>=</span>404<span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过 ls 命令在<code>sites-enabled</code>目录新建一个链接，好让 Nginx 在启动过程中会读取这个目录：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo ln -s /etc/nginx/sites-available/ponderduck.conf /etc/nginx/sites-enabled/
</span></span></code></pre></td></tr></table></div></div><p>打开文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /etc/nginx/nginx.conf
</span></span></code></pre></td></tr></table></div></div><p>找到<code>server_names_hash_bucket_size</code>指令并删除<code>#</code>符号：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>http <span class=o>{</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    server_names_hash_bucket_size 64<span class=p>;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>接下来，测试以确保我们在 Nginx 文件中的改动，没有任何问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nginx -t
</span></span></code></pre></td></tr></table></div></div><p>如果没有任何问题，请重新启动 Nginx：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart nginx
</span></span></code></pre></td></tr></table></div></div><p>现在通过 <a class=link href=http://ponderduck.cc target=_blank rel=noopener>http://ponderduck.cc</a> 访问服务器的时候，Nginx 会指向我们刚刚添加的那个 HTML 页面</p><h4 id=ssl>SSL</h4><h5 id=安装-certbot>安装 Certbot</h5><p>我们需要获得被信任的证书授权中心（ CA ）签发的安全证书。Let’s Encrypt 是 ISRG （ Internet Security Research Group ，互联网安全研究小组）的组织推出的免费安全证书计划。</p><p>ISRG 的发起者 EFF （电子前哨基金会）为 Let’s Encrypt 项目发布了一个官方的客户端 Certbot ，利用它可以完全自动化的获取、部署和更新安全证书</p><p>安装 Certbot</p><p>去 <a class=link href=https://certbot.eff.org/ target=_blank rel=noopener>官网</a> 选择我正在使用的 Web 服务器（Nginx）和操作系统（Ubuntu 20），操作对应的安装步骤</p><p>Ubuntu 自带 Snap，用 Snap 安装 Certbot</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo snap install --classic certbot
</span></span></code></pre></td></tr></table></div></div><p>用 ln 命令创建符号连接，将 Certbot 加入 PATH 环境变量中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo ln -s /snap/bin/certbot /usr/bin/certbot
</span></span></code></pre></td></tr></table></div></div><h5 id=生成-ssl-证书>生成 SSL 证书</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo certbot --nginx -d www.ponderduck.cc
</span></span></code></pre></td></tr></table></div></div><p>输入邮箱地址，用于接收邮件</p><p>输入 <code>Y</code>，同意协议；询问是否接收前哨基金会的邮件，接不接收都行</p><p>返回（注意证书储存位置）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Successfully received certificate.
</span></span><span class=line><span class=cl>Certificate is saved at: /etc/letsencrypt/live/www.ponderduck.cc/fullchain.pem
</span></span><span class=line><span class=cl>Key is saved at:         /etc/letsencrypt/live/www.ponderduck.cc/privkey.pem
</span></span><span class=line><span class=cl>This certificate expires on 2023-02-18.
</span></span><span class=line><span class=cl>These files will be updated when the certificate renews.
</span></span><span class=line><span class=cl>Certbot has set up a scheduled task to automatically renew this certificate in the background.
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s Encrypt 的 SSL 证书会在 90 天后过期，但是 Certbot 会自动续订</p><p>测试证书自动续订是否生效</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo certbot renew --dry-run
</span></span></code></pre></td></tr></table></div></div><p>返回⬇️说明已生效</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Simulating renewal of an existing certificate for www.ponderduck.cc
</span></span></code></pre></td></tr></table></div></div><p>找到存放站点证书的目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo ls /etc/letsencrypt/live
</span></span></code></pre></td></tr></table></div></div><p>我的是<code>www.ponderduck.cc</code></p><p>查询证书</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo ls /etc/letsencrypt/live/www.ponderduck.cc
</span></span></code></pre></td></tr></table></div></div><p>返回文件名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cert.pem  chain.pem  fullchain.pem  privkey.pem  
</span></span></code></pre></td></tr></table></div></div><p>后两个要添加到 Nginx 配置文件 <code>.conf</code> 里</p><h4 id=反向代理>反向代理</h4><p>修改网站配置文件</p><p>参考 <a class=link href=https://misskey-hub.net/en/docs/admin/nginx.html target=_blank rel=noopener>官网文档</a>，以下是我的完整文件内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># For WebSocket
</span></span><span class=line><span class=cl>map $http_upgrade $connection_upgrade {
</span></span><span class=line><span class=cl>    default upgrade;
</span></span><span class=line><span class=cl>    &#39;&#39;      close;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=cache1:16m max_size=1g inactive=720m use_temp_path=off;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>server {
</span></span><span class=line><span class=cl>       listen 80;
</span></span><span class=line><span class=cl>       listen [::]:80;
</span></span><span class=line><span class=cl>       server_name www.ponderduck.cc ponderduck.cc;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       # For SSL domain validation
</span></span><span class=line><span class=cl>       root /var/www/html;
</span></span><span class=line><span class=cl>       location /.well-known/acme-challenge/ { allow all; }
</span></span><span class=line><span class=cl>       location /.well-known/pki-validation/ { allow all; }
</span></span><span class=line><span class=cl>       location / { return 301 https://$server_name$request_uri; }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>server {
</span></span><span class=line><span class=cl>        listen [::]:443 ssl http2;
</span></span><span class=line><span class=cl>        listen 443 ssl http2; 
</span></span><span class=line><span class=cl>        server_name ponderduck.cc www.ponderduck.cc;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        ssl_session_cache shared:ssl_session_cache:10m;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        # ssl
</span></span><span class=line><span class=cl>        ssl_certificate /etc/letsencrypt/live/www.ponderduck.cc/fullchain.pem;
</span></span><span class=line><span class=cl>        ssl_certificate_key /etc/letsencrypt/live/www.ponderduck.cc/privkey.pem; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        include /etc/letsencrypt/options-ssl-nginx.conf;
</span></span><span class=line><span class=cl>        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; 
</span></span><span class=line><span class=cl>        ssl_stapling on;
</span></span><span class=line><span class=cl>        ssl_stapling_verify on;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        # Change to your upload limit
</span></span><span class=line><span class=cl>        client_max_body_size 80m;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        # 对&#34;/&#34;启用反向代理
</span></span><span class=line><span class=cl>        location / {
</span></span><span class=line><span class=cl>                # 指定转发地址
</span></span><span class=line><span class=cl>                proxy_pass http://127.0.0.1:3001;
</span></span><span class=line><span class=cl>                proxy_set_header Host $host;
</span></span><span class=line><span class=cl>                proxy_http_version 1.1;
</span></span><span class=line><span class=cl>                proxy_redirect off;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                proxy_set_header   Upgrade             $http_upgrade;
</span></span><span class=line><span class=cl>                proxy_set_header   Connection          $connection_upgrade;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                proxy_cache cache1;
</span></span><span class=line><span class=cl>                proxy_cache_lock on;
</span></span><span class=line><span class=cl>                proxy_cache_use_stale updating;
</span></span><span class=line><span class=cl>                add_header X-Cache $upstream_cache_status;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>接下来，测试以确保我们在 Nginx 文件中的改动，没有任何问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nginx -t
</span></span></code></pre></td></tr></table></div></div><p>有问题的话按照提示修改，做完之后，重新启动 Nginx：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart nginx
</span></span></code></pre></td></tr></table></div></div><p>现在 SSL 证书和反向代理都生效了，尝试用域名访问站点</p><p>完成🎉</p><p>注册一个账号，回到命令行工具把它设置为管理员</p><h2 id=日常维护>日常维护</h2><h3 id=更新>更新</h3><p>Docker-compose 部署</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> data/docker_data/misskey
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker-compose down 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp -r /root/data/docker_data/misskey /root/data/docker_data/misskey.archive  <span class=c1># 万事先备份，以防万一，其实这边没必要，因为我们没有映射到本地文件夹</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker-compose pull
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker-compose up -d    <span class=c1># 请不要使用docker-compose stop来停止容器，因为这么做需要额外的时间等待容器停止；docker-compose up -d直接升级容器时会自动停止并立刻重建新的容器，完全没有必要浪费那些时间。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker image prune  <span class=c1># prune 命令用来删除不再使用的 docker 对象。删除所有未被 tag 标记和未被容器使用的镜像</span>
</span></span></code></pre></td></tr></table></div></div><p>提示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>WARNING! This will remove all dangling images.
</span></span><span class=line><span class=cl>Are you sure you want to continue? [y/N] 
</span></span></code></pre></td></tr></table></div></div><p>输入 <code>y</code></p><h3 id=卸载>卸载</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cd /root/data/docker_data/misskey
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>docker-compose down 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rm -rf /root/data/docker_data/misskey  # 完全删除映射到本地的数据
</span></span></code></pre></td></tr></table></div></div><h3 id=删除旧数据>删除旧数据</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker system prune
</span></span></code></pre></td></tr></table></div></div><h3 id=磁盘空间分析及清理>磁盘空间分析及清理</h3><p>内容主要来源：https://www.cnblogs.com/jing99/p/10487174.html</p><p>有时候要用 <code>sudo</code></p><h4 id=df-命令>df 命令</h4><p>可以查看一级文件夹大小、使用比例、档案系统和挂入dian</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@oms ~]# df -Th
</span></span><span class=line><span class=cl>Filesystem     Type      Size  Used Avail Use% Mounted on
</span></span><span class=line><span class=cl>/dev/vda1      ext4       40G   35G  3.1G  92% /
</span></span><span class=line><span class=cl>devtmpfs       devtmpfs  1.9G     0  1.9G   0% /dev
</span></span><span class=line><span class=cl>tmpfs          tmpfs     1.9G     0  1.9G   0% /dev/shm
</span></span><span class=line><span class=cl>tmpfs          tmpfs     1.9G  191M  1.7G  11% /run
</span></span><span class=line><span class=cl>tmpfs          tmpfs     1.9G     0  1.9G   0% /sys/fs/cgroup
</span></span><span class=line><span class=cl>tmpfs          tmpfs     379M     0  379M   0% /run/user/0
</span></span></code></pre></td></tr></table></div></div><p>七个字段分别为档案系统、类型、该分割区的容量、已使用的大小、剩下的大小、使用的百分比和挂入点</p><h4 id=du命令>du命令</h4><p>用来查看目录或文件所占用磁盘空间的大小。常用选项组合为：<code>du -sh [目录]</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>du -s 目录 | sort -rn        #这是按字节排序
</span></span><span class=line><span class=cl>du -sh 目录 | sort -rn        #这是按兆（M）来排序
</span></span><span class=line><span class=cl>#由于-sh大小显示看起来是乱的，因此建议使用du -s|sort -nr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>du -s 目录 | sort -rn | head        #选出排在前面的10个
</span></span><span class=line><span class=cl>du -s 目录 | sort -rn | tail        #选出排在后面的10个
</span></span></code></pre></td></tr></table></div></div><p>常用选项</p><blockquote><p>-h：以人类可读的方式显示</p><p>-a：显示目录占用的磁盘空间大小，还要显示其下目录和文件占用磁盘空间的大小</p><p>-s：只显示<strong>目录占用的磁盘空间</strong>大小，不显示其子目录和文件占用的磁盘空间大小</p><p>-c：显示几个<strong>目录或文件占用的磁盘</strong>空间大小，还要统计它们的总和</p><p>&ndash;apparent-size：显示目录或文件自身的大小(文件或目录占用磁盘空间的大小与它们自身大小有时候并非完全一致)</p><p>-l ：统计硬链接占用磁盘空间的大小</p><p>-L：统计符号链接所指向的文件占用的磁盘空间大小。</p></blockquote><h4 id=rm-命令>rm 命令</h4><p>慎用</p><p>以下待做：</p><p><a class=link href=https://fediverse.eu.org/discussion/15/%E7%BB%99%E6%96%B0%E7%AB%99%E9%95%BF-%E5%BB%BA%E7%AB%99%E5%90%8E%E5%8F%AF%E5%8F%82%E8%80%83%E7%9A%84%E8%BF%90%E7%BB%B4%E5%8F%8A%E8%A3%85%E4%BF%AE%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C#latest target=_blank rel=noopener>https://fediverse.eu.org/discussion/15/%E7%BB%99%E6%96%B0%E7%AB%99%E9%95%BF-%E5%BB%BA%E7%AB%99%E5%90%8E%E5%8F%AF%E5%8F%82%E8%80%83%E7%9A%84%E8%BF%90%E7%BB%B4%E5%8F%8A%E8%A3%85%E4%BF%AE%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C#latest</a></p><p><a class=link href=https://pullopen.github.io/tags/#Mastodon target=_blank rel=noopener>https://pullopen.github.io/tags/#Mastodon</a></p><ul><li>扫描出不属于任何媒体附件的文件并移除他们</li><li>清除缓存存储</li><li>从数据库中删除未被引用的嘟文，例如来自中继的或来自本地用户不再关注的用户的嘟文，同时没有被回复的或以其他方式与之互动的</li></ul><h3 id=常用命令>常用命令</h3><p>查看 docker 容器状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo docker container stats
</span></span></code></pre></td></tr></table></div></div><h2 id=其它参考>其它参考</h2><p><a class=link href=https://blog.laoda.de/archives/getting-started-with-linux target=_blank rel=noopener>mjj版的linux入门教程</a></p><p><a class=link href=https://weirenxue.github.io/2021/06/17/user_linux_sudo/ target=_blank rel=noopener>[User] Linux 新增使用者並賦予其使用 sudo 的權限</a></p><p><a class=link href=https://blog.laoda.de/archives/how-to-secure-a-linux-server target=_blank rel=noopener>保护好你的小鸡！保姆级服务器安全教程！</a></p><p><a class=link href=https://blog.laoda.de/archives/docker-compose-install-misskey#5.3-%E5%AE%89%E8%A3%85nginxproxymanager target=_blank rel=noopener>【好玩儿的Docker项目】10分钟搭建一个去中心化微博平台——Misskey ｜二次元风格、联邦宇宙</a></p><p><a class=link href=https://candinya.com/posts/minimal-misskey-docker-deploy/ target=_blank rel=noopener>使用Docker最小化部署Misskey</a></p><p><a class=link href=https://eri.cx/build-your-own-decentralized-social-platform-misskey/ target=_blank rel=noopener>搭建属于自己的去中心化社交平台 Misskey</a></p><p><a class=link href=https://kalacloud.com/blog/how-to-install-nginx-on-ubuntu-20-04/#%E7%AC%AC5%E6%AD%A5%E8%AE%BE%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9D%97server-block target=_blank rel=noopener>如何在 Ubuntu 20.04 中安装和配置 Nginx</a></p><p><a class=link href=https://zxuqian.cn/install-nginx-on-ubuntu-20-04/ target=_blank rel=noopener>Nginx 教程：如何在 Ubuntu 20.04 下安装并配置 Nginx</a></p><p><a class=link href=https://www.myfreax.com/secure-nginx-with-let-s-encrypt-on-ubuntu-20-04/ target=_blank rel=noopener>如何在Ubuntu 20.04 Nginx配置Let&rsquo;s Encrypt SSL证书</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/tutorial/>tutorial</a>
<a href=/tags/miskey/>miskey</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/2023/operation-and-maintenance-pleroma/><div class=article-details><h2 class=article-title>Pleroma | 维护日志</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//bizarreadventure.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2023 Rubber Duck's Bizarre Adventure</section><section class=powerby>CC BY-NC-SA 4.0<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.14.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#购买-vps>购买 VPS</a><ol><li><a href=#注册>注册</a></li><li><a href=#创建-vps>创建 VPS</a></li><li><a href=#检查-ip>检查 IP</a></li></ol></li><li><a href=#域名>域名</a><ol><li><a href=#解析域名>解析域名</a></li></ol></li><li><a href=#服务器基础配置>服务器基础配置</a><ol><li><a href=#远程连接>远程连接</a></li><li><a href=#安全设置>安全设置</a><ol><li><a href=#新建普通用户并设定密码>新建普通用户并设定密码</a></li><li><a href=#赋予-vpsadmin-使用-sudo-指令的权限>赋予 「vpsadmin」 使用 sudo 指令的权限</a></li><li><a href=#可选ssh免密登录>[可选]SSH免密登录</a></li><li><a href=#禁止-root-登录>禁止 root 登录</a></li></ol></li><li><a href=#搭建环境>搭建环境</a><ol><li><a href=#修改服务器时间>修改服务器时间</a></li><li><a href=#安装常用命令>安装常用命令</a></li><li><a href=#添加-swap>添加 SWAP</a></li><li><a href=#配置防火墙>配置防火墙</a></li><li><a href=#安装-docker-和-docker-compose>安装 Docker 和 Docker Compose</a></li></ol></li></ol></li><li><a href=#misskey>Misskey</a><ol><li><a href=#创建安装目录>创建安装目录</a></li><li><a href=#配置安装文件>配置安装文件</a></li><li><a href=#部署>部署</a></li><li><a href=#访问站点>访问站点</a></li><li><a href=#nginx>Nginx</a><ol><li><a href=#安装-nginx>安装 Nginx</a></li><li><a href=#设置服务器块>设置服务器块</a></li><li><a href=#ssl>SSL</a></li><li><a href=#反向代理>反向代理</a></li></ol></li></ol></li><li><a href=#日常维护>日常维护</a><ol><li><a href=#更新>更新</a></li><li><a href=#卸载>卸载</a></li><li><a href=#删除旧数据>删除旧数据</a></li><li><a href=#磁盘空间分析及清理>磁盘空间分析及清理</a><ol><li><a href=#df-命令>df 命令</a></li><li><a href=#du命令>du命令</a></li><li><a href=#rm-命令>rm 命令</a></li></ol></li><li><a href=#常用命令>常用命令</a></li></ol></li><li><a href=#其它参考>其它参考</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>